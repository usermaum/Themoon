# ğŸ“¦ ë°°í¬ ê°€ì´ë“œ (Deployment Guide)

**ì‘ì„±ì¼:** 2025-10-24
**ìƒíƒœ:** Phase 4 ìµœì¢… ë°°í¬ ê°€ì´ë“œ
**ì‹œìŠ¤í…œ:** The Moon Drip BAR - ë¡œìŠ¤íŒ… ë¹„ìš© ê³„ì‚° ì‹œìŠ¤í…œ
**ìŠ¤íƒ:** Streamlit + SQLite + Plotly + Pandas + NumPy

---

## ğŸ“‹ ëª©ì°¨

1. [ë¹ ë¥¸ ì‹œì‘ (Quick Start)](#-ë¹ ë¥¸-ì‹œì‘)
2. [ë°°í¬ í™˜ê²½ ì„¤ì •](#-ë°°í¬-í™˜ê²½-ì„¤ì •)
3. [Docker ì»¨í…Œì´ë„ˆí™”](#-docker-ì»¨í…Œì´ë„ˆí™”)
4. [í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ì„±](#-í”„ë¡œë•ì…˜-í™˜ê²½-êµ¬ì„±)
5. [ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬](#-ë°ì´í„°ë² ì´ìŠ¤-ê´€ë¦¬)
6. [ëª¨ë‹ˆí„°ë§ & ë¡œê¹…](#-ëª¨ë‹ˆí„°ë§--ë¡œê¹…)
7. [ë³´ì•ˆ ê°•í™”](#-ë³´ì•ˆ-ê°•í™”)
8. [ì„±ëŠ¥ ìµœì í™” (ë°°í¬)](#-ì„±ëŠ¥-ìµœì í™”-ë°°í¬)
9. [ë¬¸ì œ í•´ê²°](#-ë¬¸ì œ-í•´ê²°)
10. [ìŠ¤ì¼€ì¼ë§](#-ìŠ¤ì¼€ì¼ë§)
11. [ë¡¤ë°± ì ˆì°¨](#-ë¡¤ë°±-ì ˆì°¨)

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### ë°©ë²• 1: ë¡œì»¬ ë°°í¬ (ê°œë°œ/í…ŒìŠ¤íŠ¸)

```bash
# 1. ì €ì¥ì†Œ í´ë¡ 
git clone <repository-url>
cd TheMoon_Project

# 2. ê°€ìƒ í™˜ê²½ ì„¤ì •
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# ë˜ëŠ”
venv\Scripts\activate  # Windows

# 3. ì˜ì¡´ì„± ì„¤ì¹˜
./venv/bin/pip install -r requirements.txt

# 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
./venv/bin/streamlit run app/app.py --server.port 8501

# 5. ë¸Œë¼ìš°ì € ì ‘ì†
# http://localhost:8501
```

### ë°©ë²• 2: Docker ë°°í¬ (ê¶Œì¥)

```bash
# 1. Docker ì´ë¯¸ì§€ ë¹Œë“œ
docker build -t themoon-roasting:v2.0.0 .

# 2. ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker run -d \
  --name themoon-app \
  -p 8501:8501 \
  -v $(pwd)/Data:/app/Data \
  -v $(pwd)/logs:/app/logs \
  themoon-roasting:v2.0.0

# 3. ì‹¤í–‰ í™•ì¸
docker logs themoon-app
docker ps | grep themoon-app
```

### ë°©ë²• 3: í´ë¼ìš°ë“œ ë°°í¬ (Streamlit Cloud)

```bash
# 1. ì €ì¥ì†Œë¥¼ GitHubì— í‘¸ì‹œ
git push origin main

# 2. https://share.streamlit.ioì— ì ‘ì†
# 3. ì €ì¥ì†Œ, ë¸Œëœì¹˜, ë©”ì¸ íŒŒì¼ ê²½ë¡œ ì§€ì •
# 4. "Deploy" ë²„íŠ¼ í´ë¦­
```

---

## âš™ï¸ ë°°í¬ í™˜ê²½ ì„¤ì •

### ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­

| í•­ëª© | ì‚¬ìš©ì ìˆ˜ | ìµœì†Œ ì‚¬ì–‘ | ê¶Œì¥ ì‚¬ì–‘ |
|------|---------|---------|---------|
| **ì‚¬ìš©ì ìˆ˜** | 1-5ëª… | 1-5ëª… | 5-20ëª… |
| **CPU** | 2 cores | 2 cores | 4 cores |
| **RAM** | 2GB | 2GB | 4GB |
| **ìŠ¤í† ë¦¬ì§€** | 10GB | 10GB | 20GB |
| **OS** | Linux/macOS/Windows | Ubuntu 20.04 LTS | Ubuntu 22.04 LTS |
| **Python** | 3.8+ | 3.9+ | 3.10+ |

### í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

`.env` íŒŒì¼ ìƒì„±:

```bash
# í™˜ê²½ ì„¤ì •
STREAMLIT_SERVER_PORT=8501
STREAMLIT_SERVER_ADDRESS=0.0.0.0
STREAMLIT_SERVER_HEADLESS=true
STREAMLIT_LOGGER_LEVEL=warning
STREAMLIT_CLIENT_TOOLBAR_MODE=minimal

# ë°ì´í„°ë² ì´ìŠ¤
DATABASE_PATH=./Data/roasting_data.db
DATABASE_BACKUP_PATH=./Data/backups

# ë¡œê¹…
LOG_LEVEL=INFO
LOG_PATH=./logs
LOG_MAX_SIZE=50MB
LOG_BACKUP_COUNT=10

# ë³´ì•ˆ
ALLOWED_IPS=192.168.1.0/24
SESSION_TIMEOUT=3600
ENABLE_HTTPS=true
CERT_PATH=/etc/ssl/certs/themoon.crt
KEY_PATH=/etc/ssl/private/themoon.key

# ëª¨ë‹ˆí„°ë§
ENABLE_METRICS=true
METRICS_PORT=9090
HEALTH_CHECK_INTERVAL=60
```

í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (`app/app.py`):

```python
import os
from dotenv import load_dotenv

load_dotenv()

# í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
STREAMLIT_PORT = os.getenv('STREAMLIT_SERVER_PORT', 8501)
DATABASE_PATH = os.getenv('DATABASE_PATH', 'Data/roasting_data.db')
LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')
```

---

## ğŸ³ Docker ì»¨í…Œì´ë„ˆí™”

### Dockerfile ì‘ì„±

```dockerfile
FROM python:3.10-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p Data logs

# Streamlit ì„¤ì •
RUN mkdir -p ~/.streamlit && \
    echo "[server]" > ~/.streamlit/config.toml && \
    echo "port = 8501" >> ~/.streamlit/config.toml && \
    echo "headless = true" >> ~/.streamlit/config.toml && \
    echo "[logger]" >> ~/.streamlit/config.toml && \
    echo "level = \"warning\"" >> ~/.streamlit/config.toml

# í—¬ìŠ¤ ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8501

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["streamlit", "run", "app/app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

### Docker Compose ì„¤ì •

```yaml
# docker-compose.yml
version: '3.8'

services:
  themoon-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: themoon-roasting-app
    ports:
      - "8501:8501"
    volumes:
      - ./Data:/app/Data
      - ./logs:/app/logs
      - ./config:/app/config
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_LOGGER_LEVEL=warning
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # (ì„ íƒì‚¬í•­) Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ
  nginx:
    image: nginx:latest
    container_name: themoon-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - themoon-app
    restart: unless-stopped
```

### Docker ë°°í¬ ëª…ë ¹ì–´

```bash
# ì´ë¯¸ì§€ ë¹Œë“œ
docker build -t themoon-roasting:v2.0.0 .

# ì´ë¯¸ì§€ íƒœê·¸ (ë ˆì§€ìŠ¤íŠ¸ë¦¬)
docker tag themoon-roasting:v2.0.0 myregistry.azurecr.io/themoon-roasting:v2.0.0

# ì´ë¯¸ì§€ í‘¸ì‹œ
docker push myregistry.azurecr.io/themoon-roasting:v2.0.0

# Docker Composeë¡œ ì‹¤í–‰
docker-compose up -d

# ë¡œê·¸ í™•ì¸
docker logs themoon-app -f

# ì»¨í…Œì´ë„ˆ ì¤‘ì§€
docker stop themoon-app

# ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
docker restart themoon-app

# ì»¨í…Œì´ë„ˆ ì‚­ì œ
docker rm themoon-app
```

---

## ğŸ¢ í”„ë¡œë•ì…˜ í™˜ê²½ êµ¬ì„±

### Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •

```nginx
# nginx.conf
upstream themoon_app {
    server themoon-app:8501;
}

# HTTPë¥¼ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
server {
    listen 80;
    server_name themoon.example.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS ì„œë²„
server {
    listen 443 ssl http2;
    server_name themoon.example.com;

    # SSL ì¸ì¦ì„œ
    ssl_certificate /etc/nginx/ssl/themoon.crt;
    ssl_certificate_key /etc/nginx/ssl/themoon.key;

    # SSL ë³´ì•ˆ ì„¤ì •
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # ë³´ì•ˆ í—¤ë”
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ì••ì¶•
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;

    # í”„ë¡ì‹œ ì„¤ì •
    location / {
        proxy_pass http://themoon_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # íƒ€ì„ì•„ì›ƒ ì„¤ì •
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocket ì§€ì›
    location /_stcore/stream {
        proxy_pass http://themoon_app/_stcore/stream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    # ì •ì  íŒŒì¼ ìºì‹œ
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        proxy_pass http://themoon_app;
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
    }
}
```

### Systemd ì„œë¹„ìŠ¤ ì„¤ì • (Linux)

```ini
# /etc/systemd/system/themoon-roasting.service
[Unit]
Description=The Moon Roasting Cost Calculator
After=network.target

[Service]
Type=simple
User=themoon
WorkingDirectory=/opt/themoon-roasting
Environment="PATH=/opt/themoon-roasting/venv/bin"
ExecStart=/opt/themoon-roasting/venv/bin/streamlit run app/app.py \
    --server.port 8501 \
    --server.address 127.0.0.1 \
    --server.headless true \
    --logger.level warning

# ìë™ ì¬ì‹œì‘
Restart=always
RestartSec=10

# ë¡œê¹…
StandardOutput=journal
StandardError=journal
SyslogIdentifier=themoon-app

[Install]
WantedBy=multi-user.target
```

ì„œë¹„ìŠ¤ ì‹œì‘:

```bash
sudo systemctl daemon-reload
sudo systemctl enable themoon-roasting
sudo systemctl start themoon-roasting
sudo systemctl status themoon-roasting
```

---

## ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬

### ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…

```python
# backup_manager.py
import sqlite3
import shutil
from datetime import datetime
import os

class BackupManager:
    def __init__(self, db_path, backup_dir):
        self.db_path = db_path
        self.backup_dir = backup_dir
        os.makedirs(backup_dir, exist_ok=True)

    def create_backup(self):
        """ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒì„±"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_file = os.path.join(
            self.backup_dir,
            f"roasting_data_{timestamp}.db"
        )

        try:
            shutil.copy2(self.db_path, backup_file)
            print(f"âœ… ë°±ì—… ìƒì„± ì™„ë£Œ: {backup_file}")
            return backup_file
        except Exception as e:
            print(f"âŒ ë°±ì—… ì‹¤íŒ¨: {e}")
            return None

    def restore_backup(self, backup_file):
        """ë°±ì—…ì—ì„œ ë³µì›"""
        try:
            # í˜„ì¬ DB ë°±ì—…
            self.create_backup()

            # ë³µì›
            shutil.copy2(backup_file, self.db_path)
            print(f"âœ… ë³µì› ì™„ë£Œ: {backup_file}")
            return True
        except Exception as e:
            print(f"âŒ ë³µì› ì‹¤íŒ¨: {e}")
            return False

    def get_backup_list(self):
        """ë°±ì—… ëª©ë¡ ì¡°íšŒ"""
        backups = []
        for file in sorted(os.listdir(self.backup_dir), reverse=True):
            if file.endswith('.db'):
                file_path = os.path.join(self.backup_dir, file)
                file_size = os.path.getsize(file_path) / 1024 / 1024  # MB
                mod_time = datetime.fromtimestamp(
                    os.path.getmtime(file_path)
                ).strftime("%Y-%m-%d %H:%M:%S")
                backups.append({
                    'file': file,
                    'path': file_path,
                    'size_mb': round(file_size, 2),
                    'modified': mod_time
                })
        return backups

    def cleanup_old_backups(self, keep_count=10):
        """ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ"""
        backups = self.get_backup_list()
        if len(backups) > keep_count:
            for backup in backups[keep_count:]:
                try:
                    os.remove(backup['path'])
                    print(f"ğŸ—‘ï¸  ì‚­ì œë¨: {backup['file']}")
                except Exception as e:
                    print(f"âŒ ì‚­ì œ ì‹¤íŒ¨: {e}")
```

ìë™ ë°±ì—… ìŠ¤ì¼€ì¤„ (Cron):

```bash
# ë§¤ì¼ ìì • ë°±ì—…
0 0 * * * cd /opt/themoon-roasting && /usr/bin/python3 app/backup_manager.py

# ë§¤ì£¼ ì¼ìš”ì¼ ì „ì²´ ë°±ì—… ë° ì •ë¦¬
0 1 * * 0 cd /opt/themoon-roasting && /usr/bin/python3 app/backup_manager.py --cleanup
```

### ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

```python
# migrations/v2_0_0.py
from sqlalchemy import Column, String, DateTime
from datetime import datetime

def migrate_to_v2_0_0(engine):
    """v1.0.0 â†’ v2.0.0 ë§ˆì´ê·¸ë ˆì´ì…˜"""

    with engine.connect() as conn:
        # ìƒˆ ì»¬ëŸ¼ ì¶”ê°€
        conn.execute("""
            ALTER TABLE roasting_logs
            ADD COLUMN IF NOT EXISTS updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        """)

        # ì¸ë±ìŠ¤ ì¶”ê°€
        conn.execute("""
            CREATE INDEX IF NOT EXISTS idx_bean_status
            ON beans(status)
        """)

        conn.execute("""
            CREATE INDEX IF NOT EXISTS idx_transaction_date
            ON roasting_logs(date)
        """)

        conn.commit()
        print("âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: v2.0.0")
```

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§ & ë¡œê¹…

### ë¡œê¹… ì„¤ì •

```python
# app/utils/logger.py
import logging
import os
from logging.handlers import RotatingFileHandler

def setup_logger(name, log_level='INFO'):
    """ë¡œê±° ì„¤ì •"""

    # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
    os.makedirs('logs', exist_ok=True)

    # ë¡œê±° ìƒì„±
    logger = logging.getLogger(name)
    logger.setLevel(log_level)

    # íŒŒì¼ í•¸ë“¤ëŸ¬ (ë¡œí…Œì´ì…˜)
    fh = RotatingFileHandler(
        f'logs/{name}.log',
        maxBytes=50*1024*1024,  # 50MB
        backupCount=10
    )
    fh.setLevel(log_level)

    # í¬ë§·í„°
    formatter = logging.Formatter(
        '[%(asctime)s] %(levelname)s - %(name)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    fh.setFormatter(formatter)

    # ë¡œê±°ì— í•¸ë“¤ëŸ¬ ì¶”ê°€
    logger.addHandler(fh)

    return logger

# ì‚¬ìš© ì˜ˆ
app_logger = setup_logger('themoon_app', 'INFO')
db_logger = setup_logger('database', 'WARNING')
```

### Prometheus ë©”íŠ¸ë¦­

```python
# app/utils/metrics.py
from prometheus_client import Counter, Gauge, Histogram
import time

# ë©”íŠ¸ë¦­ ì •ì˜
request_count = Counter(
    'themoon_requests_total',
    'Total requests',
    ['method', 'endpoint']
)

request_duration = Histogram(
    'themoon_request_duration_seconds',
    'Request duration',
    ['endpoint']
)

active_users = Gauge(
    'themoon_active_users',
    'Active users count'
)

database_queries = Counter(
    'themoon_db_queries_total',
    'Database queries',
    ['operation']
)

# ì‚¬ìš© ì˜ˆ
def track_request(method, endpoint):
    request_count.labels(method=method, endpoint=endpoint).inc()

def track_duration(endpoint):
    def decorator(func):
        def wrapper(*args, **kwargs):
            start = time.time()
            result = func(*args, **kwargs)
            duration = time.time() - start
            request_duration.labels(endpoint=endpoint).observe(duration)
            return result
        return wrapper
    return decorator
```

### í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸

```python
# app/pages/10_í—¬ìŠ¤ì²´í¬.py (ë˜ëŠ” API)
import streamlit as st
import json
from datetime import datetime
import psutil
import sqlite3

@st.cache_data(ttl=10)
def get_system_health():
    """ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ"""

    health = {
        "timestamp": datetime.now().isoformat(),
        "status": "healthy",
        "services": {}
    }

    # CPU ì²´í¬
    cpu_percent = psutil.cpu_percent(interval=1)
    health["services"]["cpu"] = {
        "status": "ok" if cpu_percent < 80 else "warning",
        "usage_percent": cpu_percent
    }

    # ë©”ëª¨ë¦¬ ì²´í¬
    memory = psutil.virtual_memory()
    health["services"]["memory"] = {
        "status": "ok" if memory.percent < 80 else "warning",
        "usage_percent": memory.percent,
        "available_mb": round(memory.available / 1024 / 1024, 2)
    }

    # ë””ìŠ¤í¬ ì²´í¬
    disk = psutil.disk_usage('/')
    health["services"]["disk"] = {
        "status": "ok" if disk.percent < 90 else "warning",
        "usage_percent": disk.percent,
        "free_gb": round(disk.free / 1024 / 1024 / 1024, 2)
    }

    # ë°ì´í„°ë² ì´ìŠ¤ ì²´í¬
    try:
        conn = sqlite3.connect('Data/roasting_data.db')
        cursor = conn.cursor()
        cursor.execute('SELECT COUNT(*) FROM beans')
        bean_count = cursor.fetchone()[0]
        conn.close()

        health["services"]["database"] = {
            "status": "ok",
            "connected": True,
            "table_count": 5,
            "record_count": bean_count
        }
    except Exception as e:
        health["services"]["database"] = {
            "status": "error",
            "connected": False,
            "error": str(e)
        }
        health["status"] = "unhealthy"

    return health

# Streamlit UI
st.set_page_config(page_title="í—¬ìŠ¤ì²´í¬", page_icon="ğŸ¥")
st.title("ğŸ¥ ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬")

health = get_system_health()

# ìƒíƒœ í‘œì‹œ
col1, col2, col3, col4 = st.columns(4)
with col1:
    st.metric("CPU ì‚¬ìš©ë¥ ", f"{health['services']['cpu']['usage_percent']:.1f}%")
with col2:
    st.metric("ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ", f"{health['services']['memory']['usage_percent']:.1f}%")
with col3:
    st.metric("ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ", f"{health['services']['disk']['usage_percent']:.1f}%")
with col4:
    st.metric("DB ìƒíƒœ", "ğŸŸ¢ ì •ìƒ" if health['services']['database']['status'] == 'ok' else "ğŸ”´ ì˜¤ë¥˜")

st.divider()
st.json(health)
```

---

## ğŸ” ë³´ì•ˆ ê°•í™”

### HTTPS/SSL ì„¤ì •

```bash
# Let's Encryptë¥¼ ì‚¬ìš©í•œ SSL ì¸ì¦ì„œ ìƒì„±
sudo certbot certonly --standalone \
  -d themoon.example.com \
  --email admin@example.com

# ì¸ì¦ì„œ ìœ„ì¹˜
# /etc/letsencrypt/live/themoon.example.com/fullchain.pem
# /etc/letsencrypt/live/themoon.example.com/privkey.pem

# Nginx ì„¤ì •ì— ì ìš©
# ssl_certificate /etc/letsencrypt/live/themoon.example.com/fullchain.pem;
# ssl_certificate_key /etc/letsencrypt/live/themoon.example.com/privkey.pem;

# ìë™ ê°±ì‹  (Cron)
0 2 * * * certbot renew --quiet && systemctl reload nginx
```

### ì¸ì¦ & ê¶Œí•œ ê´€ë¦¬

```python
# app/utils/auth.py
import streamlit as st
import hashlib
import hmac

class AuthManager:
    def __init__(self, users_db='users.json'):
        self.users_db = users_db

    def hash_password(self, password):
        """ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ"""
        return hashlib.sha256(password.encode()).hexdigest()

    def verify_password(self, password, hashed):
        """ë¹„ë°€ë²ˆí˜¸ ê²€ì¦"""
        return self.hash_password(password) == hashed

    def login_user(self, username, password):
        """ì‚¬ìš©ì ë¡œê·¸ì¸"""
        # ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ë° ê²€ì¦
        # st.session_stateì— ì €ì¥
        st.session_state.authenticated = True
        st.session_state.username = username

    def logout_user(self):
        """ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ"""
        st.session_state.authenticated = False
        st.session_state.username = None

def require_auth():
    """ì¸ì¦ í•„ìˆ˜ ë°ì½”ë ˆì´í„°"""
    if 'authenticated' not in st.session_state or not st.session_state.authenticated:
        st.warning("âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        st.stop()
```

ë¡œê·¸ì¸ í˜ì´ì§€:

```python
# app/pages/0_ë¡œê·¸ì¸.py
import streamlit as st
from app.utils.auth import AuthManager

st.set_page_config(page_title="ë¡œê·¸ì¸", page_icon="ğŸ”")

auth = AuthManager()

st.title("ğŸ” ë¡œê·¸ì¸")

username = st.text_input("ì‚¬ìš©ìëª…")
password = st.text_input("ë¹„ë°€ë²ˆí˜¸", type="password")

if st.button("ë¡œê·¸ì¸"):
    if auth.login_user(username, password):
        st.success("âœ… ë¡œê·¸ì¸ ì„±ê³µ!")
        st.rerun()
    else:
        st.error("âŒ ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.")
```

### ë°ì´í„° ì•”í˜¸í™”

```python
# app/utils/encryption.py
from cryptography.fernet import Fernet
import os

class EncryptionManager:
    def __init__(self, key_file='.encryption_key'):
        self.key_file = key_file
        self.cipher = self._get_cipher()

    def _get_cipher(self):
        """ì•”í˜¸í™” í‚¤ ë¡œë“œ ë˜ëŠ” ìƒì„±"""
        if os.path.exists(self.key_file):
            with open(self.key_file, 'rb') as f:
                key = f.read()
        else:
            key = Fernet.generate_key()
            with open(self.key_file, 'wb') as f:
                f.write(key)
        return Fernet(key)

    def encrypt(self, data: str) -> str:
        """ë°ì´í„° ì•”í˜¸í™”"""
        encrypted = self.cipher.encrypt(data.encode())
        return encrypted.decode()

    def decrypt(self, encrypted_data: str) -> str:
        """ë°ì´í„° ë³µí˜¸í™”"""
        decrypted = self.cipher.decrypt(encrypted_data.encode())
        return decrypted.decode()
```

### API ë³´ì•ˆ

```python
# ì†ë„ ì œí•œ (Rate Limiting)
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@limiter.limit("100/minute")
def api_endpoint(request):
    return {"status": "ok"}

# CORS ì„¤ì •
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://themoon.example.com"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## âš¡ ì„±ëŠ¥ ìµœì í™” (ë°°í¬)

### CDN ì„¤ì •

```nginx
# Cloudflare CDNì„ í†µí•œ ìºì‹±
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    proxy_pass http://themoon_app;
    proxy_cache_valid 200 30d;
    add_header Cache-Control "public, immutable, max-age=2592000";
}
```

### ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í’€

```python
# app/utils/db_pool.py
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

def get_engine():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ (ì»¤ë„¥ì…˜ í’€ í¬í•¨)"""
    engine = create_engine(
        'sqlite:///Data/roasting_data.db',
        poolclass=QueuePool,
        pool_size=5,
        max_overflow=10,
        pool_pre_ping=True,  # ì—°ê²° ìƒíƒœ í™•ì¸
        echo=False
    )
    return engine
```

### ìºì‹± ì „ëµ

```python
# app/pages/2_ë¶„ì„.py
import streamlit as st

# í˜ì´ì§€ ìºì‹± (1ì‹œê°„)
@st.cache_data(ttl=3600)
def get_cost_analysis():
    from app.services.report_service import ReportService
    service = ReportService()
    return service.get_cost_analysis()

# ì„¸ì…˜ ìºì‹± (ì‚¬ìš©ìë³„)
@st.cache_resource
def get_database_service():
    from app.services.bean_service import BeanService
    return BeanService()
```

---

## ğŸ”§ ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œ

#### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŒ

```bash
# í¬íŠ¸ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
lsof -i :8501

# í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
kill -9 <PID>

# ë¡œê·¸ í™•ì¸
docker logs themoon-app -f

# ë©”ëª¨ë¦¬ í™•ì¸
docker stats themoon-app
```

#### 2. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜

```bash
# ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ í™•ì¸
ls -lh Data/roasting_data.db

# ë°ì´í„°ë² ì´ìŠ¤ ë¬´ê²°ì„± ê²€ì‚¬
sqlite3 Data/roasting_data.db "PRAGMA integrity_check;"

# ì†ìƒëœ ê²½ìš° ë³µì›
mv Data/roasting_data.db Data/roasting_data.db.bak
cp Data/backups/roasting_data_<timestamp>.db Data/roasting_data.db
```

#### 3. ë†’ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©

```python
# ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ í™•ì¸
import tracemalloc

tracemalloc.start()

# ... ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ...

current, peak = tracemalloc.get_traced_memory()
print(f"Current: {current / 1024 / 1024:.1f}MB; Peak: {peak / 1024 / 1024:.1f}MB")
tracemalloc.stop()
```

#### 4. ëŠë¦° ì‘ë‹µ ì†ë„

```bash
# Streamlit í”„ë¡œíŒŒì¼ë§
streamlit run app/app.py --logger.level=debug

# ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”
# EXPLAIN QUERY PLAN ì‚¬ìš©
sqlite3 Data/roasting_data.db "EXPLAIN QUERY PLAN SELECT * FROM roasting_logs WHERE date > '2025-01-01';"

# ì¸ë±ìŠ¤ ì¶”ê°€
sqlite3 Data/roasting_data.db "CREATE INDEX IF NOT EXISTS idx_date ON roasting_logs(date);"
```

### ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

```bash
# CPU ì‚¬ìš©ë¥  í™•ì¸
top -p $(lsof -ti :8501)

# ë””ìŠ¤í¬ I/O í™•ì¸
iotop -p $(lsof -ti :8501)

# ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
netstat -antp | grep 8501
```

---

## ğŸ”„ ìŠ¤ì¼€ì¼ë§

### ìˆ˜í‰ í™•ì¥ (Horizontal Scaling)

ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ë¡œ í™•ì¥:

```yaml
# docker-compose.yml (ìˆ˜í‰ í™•ì¥)
version: '3.8'

services:
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-load-balancer.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app-1
      - app-2
      - app-3

  app-1:
    build: .
    environment:
      - INSTANCE_ID=1
    restart: unless-stopped

  app-2:
    build: .
    environment:
      - INSTANCE_ID=2
    restart: unless-stopped

  app-3:
    build: .
    environment:
      - INSTANCE_ID=3
    restart: unless-stopped
```

### ë¡œë“œ ë°¸ëŸ°ì‹±

```nginx
# nginx-load-balancer.conf
upstream themoon_backend {
    least_conn;  # ìµœì†Œ ì—°ê²° ì•Œê³ ë¦¬ì¦˜
    server app-1:8501 weight=1;
    server app-2:8501 weight=1;
    server app-3:8501 weight=1;
}

server {
    listen 80;

    location / {
        proxy_pass http://themoon_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### ìƒíƒœ ìœ ì§€ (Sticky Sessions)

```nginx
# ì„¸ì…˜ ê³ ì •
upstream themoon_backend {
    least_conn;
    hash $remote_addr consistent;  # í´ë¼ì´ì–¸íŠ¸ IP ê¸°ë°˜ ë¼ìš°íŒ…
    server app-1:8501;
    server app-2:8501;
    server app-3:8501;
}
```

---

## ğŸ”™ ë¡¤ë°± ì ˆì°¨

### ë²„ì „ ê´€ë¦¬

```bash
# Docker ì´ë¯¸ì§€ íƒœê·¸
docker tag themoon-roasting:v2.0.0 themoon-roasting:latest
docker tag themoon-roasting:v2.0.0 myregistry.azurecr.io/themoon-roasting:v2.0.0

# ì´ì „ ë²„ì „ ìœ ì§€
docker pull myregistry.azurecr.io/themoon-roasting:v1.0.0
```

### ë¡¤ë°± ì ˆì°¨

#### ë°©ë²• 1: Docker ì´ë¯¸ì§€ ë¡¤ë°±

```bash
# í˜„ì¬ ë²„ì „ ì¤‘ì§€
docker stop themoon-app
docker rm themoon-app

# ì´ì „ ë²„ì „ ì‹¤í–‰
docker run -d \
  --name themoon-app \
  -p 8501:8501 \
  -v $(pwd)/Data:/app/Data \
  myregistry.azurecr.io/themoon-roasting:v1.0.0

# í—¬ìŠ¤ ì²´í¬
docker logs themoon-app
```

#### ë°©ë²• 2: ë°ì´í„°ë² ì´ìŠ¤ ë¡¤ë°±

```bash
# ë°±ì—…ì—ì„œ ë³µì›
cp Data/backups/roasting_data_<previous_timestamp>.db Data/roasting_data.db

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
docker restart themoon-app
```

#### ë°©ë²• 3: Git ë²„ì „ ë¡¤ë°±

```bash
# ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ëŒì•„ê°€ê¸°
git log --oneline | head -10
git revert <commit-hash>

# ë˜ëŠ”
git checkout v1.0.0

# ì´ë¯¸ì§€ ì¬ë¹Œë“œ ë° ë°°í¬
docker build -t themoon-roasting:v1.0.0 .
docker run -d --name themoon-app -p 8501:8501 themoon-roasting:v1.0.0
```

### ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

```markdown
## ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸
- [ ] ëª¨ë“  ìœ ë‹› í…ŒìŠ¤íŠ¸ í†µê³¼ (100%)
- [ ] í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

### ì½”ë“œ
- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
- [ ] ë¦°íŠ¸ ì²´í¬ í†µê³¼
- [ ] íƒ€ì… ì²´í¬ í†µê³¼
- [ ] ë²„ê·¸ í”½ìŠ¤ í™•ì¸

### ë°°í¬
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- [ ] SSL ì¸ì¦ì„œ ì¤€ë¹„
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
- [ ] ë¡¤ë°± ê³„íš ìˆ˜ë¦½
- [ ] ëª¨ë‹ˆí„°ë§ ì„¤ì •

### ìš´ì˜
- [ ] ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •
- [ ] ìë™ ë°±ì—… ìŠ¤ì¼€ì¤„
- [ ] í—¬ìŠ¤ ì²´í¬ í™œì„±í™”
- [ ] ì•Œë¦¼ ê·œì¹™ ì„¤ì •

### ë°°í¬
- [ ] ì¤€ë¹„ í™˜ê²½ ë°°í¬ ë° ê²€ì¦
- [ ] í”„ë¡œë•ì…˜ ë°°í¬
- [ ] í—¬ìŠ¤ ì²´í¬ í™•ì¸
- [ ] ë¡œê·¸ ëª¨ë‹ˆí„°ë§
```

---

## ğŸ“ ë°°í¬ í›„ ì ˆì°¨

### ì´ˆê¸° í™•ì¸

```bash
# ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸
curl -f https://themoon.example.com/_stcore/health || echo "Unhealthy"

# ë¡œê·¸ í™•ì¸
docker logs themoon-app | tail -20

# ë©”íŠ¸ë¦­ í™•ì¸
curl https://themoon.example.com/metrics

# ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
sqlite3 Data/roasting_data.db "SELECT COUNT(*) FROM beans;"
```

### ëª¨ë‹ˆí„°ë§ í™œì„±í™”

```bash
# ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
docker logs -f themoon-app

# ì„±ëŠ¥ ë©”íŠ¸ë¦­ ëª¨ë‹ˆí„°ë§
watch 'docker stats themoon-app'

# ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬
while true; do
    curl -s https://themoon.example.com/_stcore/health | jq .
    sleep 60
done
```

---

## ğŸ¯ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „

- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ (50/50 âœ…)
- [ ] ì„±ëŠ¥ ìµœì í™” ì™„ë£Œ
- [ ] ì‚¬ìš©ì ë¬¸ì„œ ì‘ì„± ì™„ë£Œ
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš
- [ ] SSL ì¸ì¦ì„œ ì¤€ë¹„
- [ ] Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- [ ] ë°±ì—… ì „ëµ ìˆ˜ë¦½

### ë°°í¬ ì¤‘

- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒì„±
- [ ] ì´ì „ ë²„ì „ ì €ì¥
- [ ] ìƒˆ ë²„ì „ ë°°í¬
- [ ] í—¬ìŠ¤ ì²´í¬ í™•ì¸
- [ ] ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### ë°°í¬ í›„

- [ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
- [ ] ì‚¬ìš©ì ë³´ê³  ìˆ˜ì§‘
- [ ] ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë¶„ì„
- [ ] ë³´ì•ˆ ë¡œê·¸ ê²€í† 
- [ ] ë°°í¬ ë¬¸ì„œí™”

---

## ğŸ“Š ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ v2.0.0

**ë¦´ë¦¬ìŠ¤ì¼:** 2025-10-24

### ìƒˆë¡œìš´ ê¸°ëŠ¥

- âœ¨ ê³ ê¸‰ ë¶„ì„ í˜ì´ì§€ ì¶”ê°€ (íŠ¸ë Œë“œ, ì˜ˆì¸¡, ROI)
- ğŸ“Š í–¥ìƒëœ ë³´ê³ ì„œ ìƒì„± (Excel, CSV ë‚´ë³´ë‚´ê¸°)
- ğŸ”§ ë™ì  ì„¤ì • ê´€ë¦¬ ì‹œìŠ¤í…œ
- ğŸ“ˆ Excel ë™ê¸°í™” ê¸°ëŠ¥

### ê°œì„ ì‚¬í•­

- ğŸš€ ì„±ëŠ¥ ìµœì í™” (2ë°° ë¹ ë¥¸ ì¿¼ë¦¬)
- ğŸ“± ë°˜ì‘í˜• UI ê°œì„ 
- ğŸ”’ ë³´ì•ˆ ê°•í™” (HTTPS, ì¸ì¦)
- ğŸ“ í¬ê´„ì ì¸ ë¬¸ì„œí™”

### ë²„ê·¸ ìˆ˜ì •

- ğŸ› ì‹œì¦ˆë„ ë¸”ë Œë“œ ë¹„ìš© ê³„ì‚° ì˜¤ë¥˜ ìˆ˜ì •
- ğŸ› ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í’€ ê°œì„ 
- ğŸ› ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬ ì•ˆì •í™”

### ì•Œë ¤ì§„ ë¬¸ì œ

- ëŒ€ìš©ëŸ‰ ë°ì´í„°ì…‹ (10,000+ê°œ)ì—ì„œ ì•½ê°„ì˜ ì§€ì—° ë°œìƒ ê°€ëŠ¥
- Streamlit 1.38.0ì˜ ì œí•œìœ¼ë¡œ ì¸í•œ ë‹¨ì¼ ì‚¬ìš©ì ì„¸ì…˜ ì œì•½

### ì§€ì› ë° ë¬¸ì˜

- ğŸ“§ support@themoon.com
- ğŸ› Issues: https://github.com/themoon/issues
- ğŸ“š Documentation: https://docs.themoon.example.com

---

**ì‘ì„±ì:** Claude Code
**ë²„ì „:** Phase 4 - v2.0.0
**ìƒíƒœ:** âœ… ë°°í¬ ê°€ëŠ¥
