# 구글 드라이브 서비스 계정 설정 가이드

> **TheMoon - 인바운드 문서 자동 업로드**
> 구글 드라이브 연동을 위한 서비스 계정 설정 완벽 가이드

---

## 📋 목차

1. [개요](#개요)
2. [무료 사용 가능 여부](#무료-사용-가능-여부)
3. [전체 과정 요약](#전체-과정-요약)
4. [1단계: 구글 클라우드 프로젝트 생성](#1단계-구글-클라우드-프로젝트-생성)
5. [2단계: 서비스 계정 생성 및 JSON 키 다운로드](#2단계-서비스-계정-생성-및-json-키-다운로드)
6. [3단계: Google Drive API 활성화](#3단계-google-drive-api-활성화)
7. [4단계: 구글 드라이브 폴더 생성 및 공유](#4단계-구글-드라이브-폴더-생성-및-공유)
8. [5단계: Render.com 환경변수 설정](#5단계-rendercom-환경변수-설정)
9. [설정 완료 확인](#설정-완료-확인)
10. [비용 및 한도](#비용-및-한도)
11. [보안 주의사항](#보안-주의사항)
12. [문제 해결](#문제-해결)

---

## 개요

TheMoon 시스템에서 인바운드 문서(발주서, 송장 등)를 구글 드라이브에 자동으로 업로드하기 위한 설정 가이드입니다.

### 기능

- 📤 인바운드 문서 자동 업로드
- 📁 구글 드라이브에 백업
- 🔗 공유 링크 자동 생성
- 🔒 안전한 서비스 계정 인증

### 필요한 것

- 구글 계정 (Gmail)
- 구글 드라이브 (15GB 무료)
- 약 15분의 시간

---

## 💰 무료 사용 가능 여부

**✅ 완전 무료입니다!**

| 서비스                     | 무료 한도    | TheMoon 사용량         | 비용    |
| -------------------------- | ------------ | ---------------------- | ------- |
| **Google Drive**     | 15GB         | ~수 MB (문서 이미지만) | 무료 ✅ |
| **Google Drive API** | 일 10억 요청 | ~수십 건/일            | 무료 ✅ |
| **서비스 계정**      | 무제한       | 1개                    | 무료 ✅ |

**결론:** 개인/소규모 비즈니스는 완전 무료로 사용 가능합니다!

---

## 🎯 전체 과정 요약

```
1. 구글 클라우드 프로젝트 생성 (3분)
   ↓
2. 서비스 계정 생성 및 JSON 키 다운로드 (5분)
   ↓
3. Google Drive API 활성화 (2분)
   ↓
4. 구글 드라이브 폴더 생성 및 공유 (3분)
   ↓
5. Render.com 환경변수 설정 (2분)
```

**총 소요 시간: 약 15분**

---

## 1단계: 구글 클라우드 프로젝트 생성

### 1-1. Google Cloud Console 접속

**링크:** https://console.cloud.google.com

**로그인:**

- 개인 구글 계정으로 로그인
- Gmail 계정이면 모두 가능

### 1-2. 새 프로젝트 만들기

**화면 상단 프로젝트 선택 드롭다운 클릭:**

```
┌─────────────────────────────┐
│ My First Project      [▼]   │  ← 이 부분 클릭
└─────────────────────────────┘
```

**팝업 창에서 "새 프로젝트" 버튼 클릭:**

```
┌────────────────────────────────┐
│  프로젝트 선택                    │
├────────────────────────────────┤
│  My First Project              │
│  ────────────────────────      │
│  [+ 새 프로젝트]  ← 클릭         │
└────────────────────────────────┘
```

**프로젝트 정보 입력:**

```
프로젝트 이름: TheMoon Coffee
위치: 조직 없음 (개인 계정은 기본값)

[만들기] 버튼 클릭
```

**대기:**

- 프로젝트 생성 완료 (10-30초)
- 알림 표시: "프로젝트 생성 완료"

---

## 2단계: 서비스 계정 생성 및 JSON 키 다운로드

### 2-1. IAM 및 관리자 메뉴 진입

**왼쪽 메뉴 (☰) → IAM 및 관리자 → 서비스 계정:**

```
☰ 탐색 메뉴
├─ IAM 및 관리자
│  ├─ IAM
│  ├─ 서비스 계정  ← 클릭
│  └─ ...
```

**또는 직접 링크:**
https://console.cloud.google.com/iam-admin/serviceaccounts

### 2-2. 서비스 계정 만들기

**"+ 서비스 계정 만들기" 버튼 클릭:**

```
┌──────────────────────────────────┐
│ 서비스 계정                         │
├──────────────────────────────────┤
│ [+ 서비스 계정 만들기]  ← 클릭      │
└──────────────────────────────────┘
```

**1단계: 서비스 계정 세부정보**

```
서비스 계정 이름: themoon-drive-uploader
서비스 계정 ID: themoon-drive-uploader
         (자동 생성됨, 수정 가능)
서비스 계정 설명: TheMoon 인바운드 문서 자동 업로드

[만들기 및 계속하기] 클릭
```

**2단계: 이 서비스 계정에 프로젝트 액세스 권한 부여 (선택사항)**

```
역할 선택: (비워둠 - 선택하지 않음)

[계속] 클릭
```

**3단계: 사용자에게 이 서비스 계정 액세스 권한 부여 (선택사항)**

```
(모두 비워둠)

[완료] 클릭
```

### 2-3. JSON 키 다운로드

**생성된 서비스 계정 목록에서:**

```
┌──────────────────────────────────────────────────┐
│ 이메일                              작업          │
├──────────────────────────────────────────────────┤
│ themoon-drive-uploader@...     [⋮]  ← 클릭        │
└──────────────────────────────────────────────────┘
```

**[⋮] 메뉴 → "키 관리" 클릭:**

```
┌─────────────────┐
│ ⋮               │
├─────────────────┤
│ 키 관리    ← 클릭 │
│ 삭제           │
│ ...            │
└─────────────────┘
```

**"키 추가" → "새 키 만들기" 클릭:**

```
┌────────────────────┐
│ 키                  │
├────────────────────┤
│ [키 추가 ▼]  ← 클릭 │
└────────────────────┘

드롭다운:
┌─────────────────┐
│ 새 키 만들기  ← 클릭│
└─────────────────┘
```

**키 유형 선택:**

```
┌─────────────────────────┐
│ 키 유형 선택              │
├─────────────────────────┤
│ ○ P12                   │
│ ● JSON  ← 선택           │
│                         │
│        [만들기]          │
└─────────────────────────┘
```

**자동 다운로드:**

- `themoon-coffee-xxxxx.json` 파일이 컴퓨터에 다운로드됨
- **이 파일을 안전하게 보관!** (비밀번호처럼 관리)

**JSON 파일 내용 예시:**

```json
{
  "type": "service_account",
  "project_id": "themoon-coffee-xxxxx",
  "private_key_id": "abc123...",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIE...",
  "client_email": "themoon-drive-uploader@themoon-coffee-xxxxx.iam.gserviceaccount.com",
  "client_id": "123456789...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  ...
}
```

---

## 3단계: Google Drive API 활성화

### 3-1. API 라이브러리 진입

**왼쪽 메뉴 (☰) → API 및 서비스 → 라이브러리:**

```
☰ 탐색 메뉴
├─ API 및 서비스
│  ├─ 라이브러리  ← 클릭
│  ├─ 사용자 인증 정보
│  └─ ...
```

**또는 직접 링크:**
https://console.cloud.google.com/apis/library

### 3-2. Google Drive API 검색

**검색창에 "drive" 입력:**

```
┌─────────────────────────────────┐
│ 🔍 API 및 서비스 검색             │
│    drive                   [🔍] │
└─────────────────────────────────┘
```

**검색 결과에서 "Google Drive API" 클릭:**

```
┌──────────────────────────────┐
│ Google Drive API      Google │  ← 클릭
│ Store and share files        │
└──────────────────────────────┘
```

### 3-3. API 사용 설정

**API 상세 페이지에서 "사용" 버튼 클릭:**

```
┌─────────────────────────────────┐
│ Google Drive API                │
├─────────────────────────────────┤
│ Store and share files in the    │
│ cloud...                        │
│                                 │
│        [사용]  ← 클릭            │
└─────────────────────────────────┘
```

**완료:**

- "API 사용 설정됨" 메시지 표시
- 약 10초 소요

---

## 4단계: 구글 드라이브 폴더 생성 및 공유

### 4-1. 구글 드라이브 접속

**링크:** https://drive.google.com

### 4-2. 폴더 생성

**좌측 "+ 새로 만들기" 버튼 클릭:**

```
┌─────────────────┐
│ + 새로 만들기 ▼  │  ← 클릭
└─────────────────┘
```

**드롭다운에서 "폴더" 선택:**

```
┌───────────────────┐
│ 폴더          📁  │  ← 클릭
│ 파일 업로드       │
│ 폴더 업로드       │
└───────────────────┘
```

**폴더 이름 입력:**

```
┌─────────────────────────┐
│ 새 폴더                  │
├─────────────────────────┤
│ 이름: TheMoon_Inbound   │
│                         │
│    [취소]    [만들기]    │
└─────────────────────────┘
```

### 4-3. 서비스 계정에 폴더 공유

**생성한 폴더 우클릭 → "공유" 클릭:**

```
TheMoon_Inbound 📁
  ↓ 우클릭
┌─────────────┐
│ 공유    ← 클릭│
│ 이름 바꾸기  │
│ 삭제        │
└─────────────┘
```

**"사용자 및 그룹과 공유" 창:**

**서비스 계정 이메일 입력:**

```
┌──────────────────────────────────────────┐
│ 사용자 및 그룹과 공유                       │
├──────────────────────────────────────────┤
│ 사용자 또는 그룹 추가                       │
│                                          │
│ themoon-drive-uploader@themoon-coffee... │
│ ↑ JSON 파일의 client_email 값 붙여넣기    │
│                                          │
│ 권한: [편집자 ▼]  ← 편집자 선택           │
│                                          │
│          [완료]                           │
└──────────────────────────────────────────┘
```

**⚠️ 중요:**

- **`client_email`** 값을 정확히 복사해서 붙여넣기
- JSON 파일을 열어서 확인:
  ```json
  {
    ...
    "client_email": "themoon-drive-uploader@themoon-coffee-xxxxx.iam.gserviceaccount.com",
    ...
  }
  ```
- **권한은 반드시 "편집자"** 선택 (파일 업로드 위해 필요)

**경고 메시지 무시:**

```
┌────────────────────────────────────────┐
│ ⚠️ "themoon-drive-uploader@..."은      │
│ Gmail 계정이 아닙니다. 계속하시겠습니까?  │
│                                        │
│      [취소]        [공유]  ← 클릭       │
└────────────────────────────────────────┘
```

**완료:**

- 폴더가 서비스 계정과 공유됨
- 이제 프로그램에서 이 폴더에 파일 업로드 가능

---

## 5단계: Render.com 환경변수 설정

### 5-1. JSON 파일 내용 복사

**다운로드한 JSON 파일을 텍스트 에디터로 열기:**

- Windows: 메모장
- Mac: TextEdit
- VSCode, Notepad++ 등

**전체 내용 복사:**

```json
{
  "type": "service_account",
  "project_id": "themoon-coffee-xxxxx",
  "private_key_id": "abc123...",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIE...",
  ...전체...
}
```

**💡 팁:** 줄바꿈이 있어도 괜찮습니다. 전체를 복사하세요.

### 5-2. Render.com 대시보드 접속

**링크:** https://dashboard.render.com

### 5-3. 환경변수 추가

**Web Services → themoon-api → Environment 탭:**

```
┌────────────────────────────────────┐
│ Environment Variables               │
├────────────────────────────────────┤
│ DATABASE_URL: postgres://...       │
│ SECRET_KEY: ********               │
│ GOOGLE_API_KEY: [여기에 입력]       │
│ GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT│
│   [여기에 JSON 전체 붙여넣기]  ← !  │
│                                    │
│ [Add Environment Variable]         │
│                                    │
│        [Save Changes]              │
└────────────────────────────────────┘
```

**`GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT` 값에 JSON 전체 붙여넣기:**

- 복사한 JSON 전체를 붙여넣기
- 한 줄로 표시되어도 정상
- 줄바꿈이 있어도 정상

### 5-4. 저장 및 재배포

**"Save Changes" 버튼 클릭:**

- 자동으로 서비스 재배포 시작
- 약 3-5분 소요

**완료 대기:**

```
┌──────────────────────────────┐
│ themoon-api                  │
├──────────────────────────────┤
│ Status: Deploying... 🔄      │
│   ↓                          │
│ Status: Live ✅  (3분 후)     │
└──────────────────────────────┘
```

---

## ✅ 설정 완료 확인

### 로그 확인

**Render.com → themoon-api → Logs 탭:**

배포 완료 후 로그에서 다음 메시지 확인:

```
✅ Google Drive Service initialized from environment variable
```

이 메시지가 보이면 **성공!** 🎉

**오류 메시지가 보이면:**

```
⚠️ Failed to parse GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT
```

→ JSON 형식이 잘못됨. 다시 복사해서 붙여넣기

### 기능 테스트

**프론트엔드에서 인바운드 문서 업로드:**

1. 프론트엔드 접속:
   https://themoon-frontend-0s4m.onrender.com/inventory/inbound
2. "새 문서 추가" 클릭
3. 이미지 업로드
4. 제출

**확인:**

- 구글 드라이브 `TheMoon_Inbound` 폴더에 파일 업로드됨
- Render.com 로그에 업로드 성공 메시지

---

## 📊 비용 및 한도

### 무료 사용 한도

| 항목                            | 무료 한도 | 예상 사용량                 |
| ------------------------------- | --------- | --------------------------- |
| **Google Drive 저장공간** | 15GB      | ~100MB (1년간 문서 수백 개) |
| **Drive API 요청**        | 10억/일   | ~10-50/일                   |
| **대역폭**                | 무제한    | ~수 MB/일                   |

**결론:** 개인/소규모 비즈니스는 **완전 무료**입니다!

### 유료 전환 시점

**언제 유료가 되나요?**

- Drive 저장공간 15GB 초과 시
- API 요청 10억/일 초과 시 (사실상 불가능)

**비용:**

- Google One 100GB: 월 $1.99
- 업그레이드 전까지 무료 사용 가능

---

## 🔒 보안 주의사항

### ✅ 해야 할 것

- ✅ JSON 키 파일 안전하게 보관
- ✅ Render.com 환경변수로만 관리
- ✅ Git에 절대 커밋하지 않기
- ✅ .gitignore에 `*.json` 패턴 추가
- ✅ 정기적으로 키 로테이션 (6개월마다)

### ❌ 하지 말 것

- ❌ JSON 파일을 공개 저장소에 올리기
- ❌ 다른 사람과 JSON 파일 공유
- ❌ 코드에 직접 하드코딩
- ❌ 이메일로 JSON 파일 전송
- ❌ 공용 컴퓨터에 JSON 파일 저장

### 키 노출 시 대응

**만약 JSON 키가 노출되었다면:**

1. **즉시 키 삭제:**

   - Google Cloud Console → 서비스 계정 → 키 관리
   - 노출된 키 삭제
2. **새 키 생성:**

   - 위의 2-3 단계 반복
3. **Render.com 환경변수 업데이트:**

   - 새 JSON으로 교체

---

## 🔧 문제 해결

### 오류 1: "Service account file not found"

**원인:**
환경변수가 설정되지 않음

**해결:**

1. Render.com → themoon-api → Environment
2. `GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT` 확인
3. 없으면 5단계 다시 진행

### 오류 2: "Failed to parse JSON"

**원인:**
JSON 형식 오류

**해결:**

1. JSON 파일을 다시 열어서 전체 복사
2. 줄바꿈, 공백 포함 전체 복사
3. Render.com에 다시 붙여넣기

### 오류 3: "Permission denied"

**원인:**
드라이브 폴더 공유 안 됨

**해결:**

1. 구글 드라이브에서 `TheMoon_Inbound` 폴더 확인
2. 서비스 계정 이메일과 공유되어 있는지 확인
3. 권한이 "편집자"인지 확인
4. 없으면 4-3 단계 다시 진행

### 오류 4: "API not enabled"

**원인:**
Google Drive API 활성화 안 됨

**해결:**

1. Google Cloud Console → API 및 서비스 → 라이브러리
2. "Google Drive API" 검색
3. "사용" 버튼 클릭

### 오류 5: "Folder not found"

**원인:**
폴더 이름 불일치

**해결:**

1. 폴더 이름이 정확히 `TheMoon_Inbound`인지 확인
2. 대소문자, 언더스코어 확인
3. 다른 이름 사용 시 코드에서 `folder_name` 수정

---

## 📚 참고 자료

### 공식 문서

- [Google Cloud Console](https://console.cloud.google.com)
- [Google Drive API 문서](https://developers.google.com/drive)
- [서비스 계정 가이드](https://cloud.google.com/iam/docs/service-accounts)

### 관련 파일

- `backend/app/services/google_drive_service.py` - 구글 드라이브 서비스 구현
- `backend/app/api/v1/endpoints/inbound.py` - 인바운드 API 엔드포인트
- `render.yaml` - Render.com 배포 설정

### 환경변수

```yaml
# render.yaml
envVars:
  - key: GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT
    sync: false  # 대시보드에서만 관리
```

---

## 💡 요약

### 5단계로 완료

1. ✅ 구글 클라우드 프로젝트 생성
2. ✅ 서비스 계정 생성 + JSON 다운로드
3. ✅ Google Drive API 활성화
4. ✅ 드라이브 폴더 공유
5. ✅ Render.com 환경변수 설정

### 핵심 포인트

- **소요 시간:** 약 15분
- **비용:** 완전 무료 ✅
- **보안:** JSON 파일 안전하게 관리
- **효과:** 자동 백업 + 공유 편리

---

**작성일:** 2025-12-19
**버전:** 1.0.0
**작성자:** Claude Code
