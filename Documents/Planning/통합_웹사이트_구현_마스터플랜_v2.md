# 🎯 더문드립바 웹사이트 구현 마스터 플랜 v2

## 로스팅 플랜 + 웹페이지 통합 구현 계획

**프로젝트명:** The Moon Drip BAR 로스팅 기반 웹사이트 재구현
**작성일:** 2025-10-29
**버전:** 2.0
**상태:** 계획 단계
**기반:** 로스팅_플랜_2025.md + 웹페이지_구현_마스터플랜.md

---

## 📑 목차

1. [Constitution (원칙)](#1-constitution-원칙)
2. [Specify (명세)](#2-specify-명세)
3. [Clarify (명확화)](#3-clarify-명확화)
4. [Plan (계획)](#4-plan-기술-스택--아키텍처)
5. [Tasks (작업 분해)](#5-tasks-작업-분해)
6. [Implement (구현)](#6-implement-자동-코드-생성)
7. [Analyze (검증)](#7-analyze-검증)

---

## 1. CONSTITUTION (원칙)

### 핵심 기본 원칙

```
┌──────────────────────────────────────────────────────────────┐
│  1. 로스팅 전문가 중심 설계 (Roasting-First Design)          │
│     → 로스팅 데이터 = 진실의 단일 소스(SSOT)                 │
│     → 로스팅 기록 → 원가 계산 → 블렌드 관리의 일관된 흐름    │
│                                                                │
│  2. 블렌딩 과학 기반                                          │
│     → 혼합률(%) 기반 원가 계산                                 │
│     → 혼합 후 손실률(17%) 명확한 처리                         │
│     → 각 블렌드별 레시피 투명한 관리                         │
│                                                                │
│  3. 현실 데이터 기반                                          │
│     → 13종 원두 (6개국)                                       │
│     → 2가지 블렌드 타입 (풀문, 뉴문)                         │
│     → 영수증 형식 월별 기록 (담당자 실제 사용 방식)          │
│     → 2개월 기존 데이터 마이그레이션 필수                    │
│                                                                │
│  4. 점진적 확장성 (Progressive Enhancement)                  │
│     → Phase 1: 로스팅 기록 입력 (단일 & 월별 그리드)         │
│     → Phase 2: 블렌드 관리 & 원가 계산                       │
│     → Phase 3: 분석 & 리포트                                 │
│     → Phase 4: 고급 기능 & 최적화                            │
│                                                                │
│  5. 데이터 신뢰성                                             │
│     → 자동 검증 (생두량, 볶은량, 혼합 비율)                  │
│     → 손실률 일관성 (17% 표준화)                             │
│     → 감사 추적 (모든 변경 기록)                             │
│                                                                │
│  6. 운영 효율성                                               │
│     → 영수증 형식 입력으로 기존 업무 프로세스 연속성         │
│     → Excel 자동 동기화                                       │
│     → 월별 자동 집계 및 보고                                 │
└──────────────────────────────────────────────────────────────┘
```

---

## 2. SPECIFY (명세)

### A. 로스팅 플랜 기반 핵심 데이터

#### 원두 현황 (13종)

| No. | 원두명 | 국가 | 현황 |
|-----|--------|------|------|
| 1 | 마사이 | 에티오피아 | 풀문 40%, 실제 로스팅 데이터 있음 |
| 2 | 안티구아 | 과테말라 | 풀문 40%, 실제 로스팅 데이터 있음 |
| 3 | 모모라 | 에티오피아 | 풀문 10%, 실제 로스팅 데이터 있음 |
| 4 | g4 | 케냐 | 풀문 10% + 뉴문 10%, 실제 로스팅 데이터 있음 |
| 5 | 브라질 | 브라질 | 뉴문 60%, 실제 로스팅 데이터 있음 |
| 6 | 콜롬비아 | 콜롬비아 | 뉴문 30%, 실제 로스팅 데이터 있음 |
| 7-13 | 기타 6종 | 혼합 | 향후 추가 예정 |

#### 블렌드 구성 (확정된 2가지)

**풀문 (Full Moon) 블렌딩**
- 마사이 40% + 안티구아 40% + 모모라 10% + g4 10% = 100%
- 생두 26,505.9kg → 로스팅 22,000kg (손실 17.0%)
- 판매가: ₩22,000

**뉴문 (New Moon) 블렌딩**
- 브라질 60% + 콜롬비아 30% + g4 10% = 100%
- 생두 4,819.3kg → 로스팅 4,000kg (손실 17.0%)
- 판매가: TBD

#### 로스팅 데이터 현황

```
보유 데이터:
- 기간: 2025년 2개월분
- 형식: 영수증 형식 (Sheet1)
- 혼합 정보: 구성표 형식 (Sheet1(2))

통계:
- 총 생두량: 31,325.3 kg
- 총 로스팅량: 26,000 kg
- 평균 손실률: 17.0%
```

### B. 웹사이트 필수 기능 (Phase별)

#### Phase 1: 로스팅 기록 관리

**🏠 대시보드**
- 월별 로스팅 요약 (생두량, 로스팅량, 손실률)
- 블렌드별 월간 구성비
- 최근 로스팅 기록 5개
- 손실률 추이 (목표 14% vs 현재 17%)

**🔥 로스팅 기록 입력**
- 2가지 입력 방식:
  1. **단일 입력 페이지** (RoastingRecord.py): 개별 로스팅 기록 입력
  2. **영수증 형식 월별 그리드** (RoastingReceipt.py): 담당자 실제 사용 방식
- 자동 손실률 계산
- 월별/원두별 기록 조회

#### Phase 2: 블렌드 & 원가 관리

**🎨 블렌딩 관리**
- 풀문/뉴문 블렌드 정보 표시
- 혼합률(%) 시각화 (파이 차트)
- 각 원두의 생두 원가 × 혼합률(%) → 블렌드 원가
- 혼합 후 손실률(17%) 반영 → 최종 원가

**💰 원가 계산 서비스**
```
계산 로직:
1. 혼합 비중별 원가 = 각 원두 생두 원가(₩/kg) × 혼합률(%)
2. 블렌드 총 원가 = Σ(혼합 비중별 원가)
3. 최종 원가 = 블렌드 총 원가 / (1 - 손실률)
   예: 혼합원가 1,000 / 0.83 = 1,204.8원 (손실률 17% 반영)
4. 수익성 = 판매가 - 최종 원가
```

#### Phase 3: 분석 & 보고서

**📊 분석 페이지**
- 월별 손실률 추이 (목표 14% 대비)
- 원두별 로스팅 통계
- 블렌드별 월간 원가 및 수익성
- 로스팅 효율성 분석

**📄 리포트 생성**
- 월간 로스팅 보고서 (PDF/Excel)
- 블렌드별 비용 분석
- 분기/연간 비교 분석

#### Phase 4: 고급 기능

**⚙️ 설정**
- 원두별 생두 원가 관리
- 블렌드별 판매가 설정
- 목표 손실률 설정
- 사용자 권한 관리

**🔄 데이터 동기화**
- Excel ↔ DB 자동 동기화
- 기존 2개월 데이터 마이그레이션
- 월별 자동 백업

### C. 기존 웹페이지 vs 개선사항

| 기능 | 기존 (app.py) | 개선사항 v2 |
|------|---|---|
| 로스팅 기록 입력 | 기본 폼 | ✨ 단일 입력 + 월별 그리드 (영수증 형식) |
| 블렌드 관리 | 포션 수 기반 | ✨ 혼합률(%) 기반 관리 |
| 원가 계산 | 간단 계산 | ✨ 혼합률 × 생두원가 / (1-손실률) 공식 |
| 손실률 추적 | 없음 | ✨ 월별/원두별/블렌드별 상세 추적 |
| 분석 | 기본 차트 | ✨ 손실률 분석, 수익성 분석, 예측 |
| 데이터 마이그레이션 | 없음 | ✨ Excel 2개월 데이터 자동 마이그레이션 |
| 보고서 | 없음 | ✨ 월간/분기/연간 자동 생성 |

---

## 3. CLARIFY (명확화)

### A. 새로운 이해사항 (로스팅 플랜에서 도출)

#### 1. 혼합률(%) 기반 설계
- **기존 오해**: "포션" = 개수 (4포션, 6포션)
- **정정**: "포션" = **혼합 비율(%)** → 100%로 합산
- **예시**:
  - 풀문: 마사이 40% + 안티구아 40% + 모모라 10% + g4 10% = 100%
  - 뉴문: 브라질 60% + 콜롬비아 30% + g4 10% = 100%

#### 2. 손실률 정의
- **기존 오해**: 각 원두별 손실률
- **정정**: **블렌딩 후 혼합 손실률** (17% 통일)
- 원인: 여러 원두를 섞어서 함께 로스팅하는 과정에서의 통합 손실률
- 계산: (생두량 - 로스팅량) / 생두량 = 손실률

#### 3. 원가 계산 로직 (명확화 v2)

**핵심 정의:**
- **혼합률(%) 기준**: 생두(raw bean) 기준
  - 마사이 40% = 생두 40%
  - 혼합 후 로스팅 시 전체적으로 17% 손실
  - 최종 비율 ≠ 혼합률 (손실 반영)

**단계별 계산:**

```
Step 1: 혼합 비중별 원가 계산 (생두 기준)
- 마사이 원가 = 30,000₩/kg × 40% = 12,000₩
- 안티구아 원가 = 25,000₩/kg × 40% = 10,000₩
- 모모라 원가 = 20,000₩/kg × 10% = 2,000₩
- g4 원가 = 18,000₩/kg × 10% = 1,800₩

Step 2: 블렌드 총 원가 (생두 기준, 손실 전)
- 혼합 원가 = 12,000 + 10,000 + 2,000 + 1,800 = 25,800₩/kg

Step 3: 손실률 반영 최종 원가 (로스팅 후 기준)
- 손실률: 17%
- 실제 판매량: 83% (100% - 17%)
- 최종 원가 = 혼합 원가 / (1 - 0.17)
            = 25,800₩ / 0.83
            = 31,084₩/kg (로스팅 후 기준)

Step 4: 수익성 분석
- 판매가: 22,000₩
- 최종 원가: 31,084₩
- 분석: 손실!

⚠️ 발견사항:
- ₩22,000은 샘플/포장 가격일 수 있음
- 실제 판매가 재확인 필요
- 또는 원가 절감 필요
```

**검증 사항:**
```
실제 데이터 검증:
- 풀문: 생두 26,505.9kg → 로스팅 22,000kg
  손실률 = (26,505.9 - 22,000) / 26,505.9 = 17.0% ✓

- 혼합률 검증:
  마사이: 10,602.4kg / 26,505.9kg = 40.0% ✓
  안티구아: 10,602.4kg / 26,505.9kg = 40.0% ✓
  모모라: 2,650.6kg / 26,505.9kg = 10.0% ✓
  g4: 2,650.6kg / 26,505.9kg = 10.0% ✓
  합계: 100% ✓
```

#### 4. 데이터 주권
- **진실의 단일 소스 (SSOT)**: 로스팅 기록
- 로스팅 기록 → 원가 계산 → 블렌드 관리의 일관된 흐름
- Excel 데이터 = 수동 기록 → DB = 자동화된 진실

#### 5. 영수증 형식의 의미
- 담당자가 실제 사용하던 방식 (월별 그리드)
- 원두별 행 × 월별 열 구조
- 생두량, 로스팅량, 손실률 자동 계산
- 기존 업무 프로세스와의 연속성

### B. 기술 결정사항

✅ **기술:** Streamlit + SQLite (기존 환경 최대 활용)
✅ **목표:** 로스팅 데이터 기반의 완전한 관리 시스템
✅ **데이터:** 실제 로스팅 일지 (13종 원두, 2가지 블렌드, 2개월분)
✅ **기간:** 7주 (로스팅 플랜 기준: 6.5주)
✅ **배포:** 로컬 + 클라우드 확장 가능

### C. 향후 확인 필요사항

```
1️⃣  추가 원두 관리
   ○ 현재 13종 중 6종만 사용 중
   ○ 향후 7종 추가 원두 어떻게 관리할지?

2️⃣  판매 기록 관리
   ○ 로스팅 기록만 관리 vs
   ○ 판매 기록도 함께 추적?

3️⃣  다중 사용자
   ○ 단일 사용자 (점주)
   ○ 다중 역할 (점주, 담당자, 직원)

4️⃣  외부 연동
   ○ 로컬만 사용
   ○ 클라우드 백업
   ○ POS 연동
```

---

## 4. PLAN (기술 스택 & 아키텍처)

### A. 기술 스택

```yaml
Frontend/Backend:
  Framework: Streamlit 1.38.0
  Language: Python 3.12.3
  Deployment: Headless mode (CLI 기반)

Database:
  Engine: SQLite 3
  ORM: SQLAlchemy 2.0+
  Schema: 로스팅 플랜 기반 (8개 테이블)

Data Processing:
  Pandas: 데이터 처리 & Excel 동기화
  NumPy: 수치 계산

Calculation:
  Loss Rate: 자동 계산 (생두량 - 로스팅량) / 생두량
  Cost: Blend Cost = Σ(원가 × 혼합률%) / (1 - 손실률)

Visualization:
  Plotly: 대시보드 차트 (손실률 추이, 블렌드 구성)
  Streamlit Charts: 기본 차트

Excel Integration:
  openpyxl: Excel 읽기/쓰기
  Pandas Excel: 데이터 동기화

Report Generation:
  ReportLab: PDF 생성
  python-docx: Word 생성
```

### B. 폴더 구조 (v2 기준)

```
TheMoon_Project/
├── venv/                         # 프로젝트 격리 환경
├── app/
│   ├── app.py                   # 메인 Streamlit 앱
│   ├── pages/
│   │   ├── Dashboard.py              # 월별 로스팅 요약
│   │   ├── RoastingRecord.py         # 단일 입력 + 조회
│   │   ├── RoastingReceipt.py        # 월별 그리드 입력 (영수증 형식)
│   │   ├── BlendManagement.py        # 혼합률 기반 블렌드 관리
│   │   ├── CostCalculation.py        # 혼합률 × 생두원가 / (1-손실률)
│   │   ├── Analysis.py               # 손실률, 수익성 분석
│   │   ├── Report.py                 # 월간 보고서 생성
│   │   └── Settings.py               # 원두 원가, 판매가, 목표 설정
│   ├── models/
│   │   ├── __init__.py
│   │   ├── database.py          # DB 연결, 세션 관리
│   │   ├── bean.py              # Bean 모델 (13종 원두)
│   │   ├── blend.py             # Blend 모델 (풀문, 뉴문)
│   │   ├── blend_recipe.py      # BlendRecipe (혼합률%)
│   │   ├── roasting_log.py      # RoastingLog (로스팅 기록)
│   │   └── transaction.py       # Transaction (판매/사용)
│   ├── services/
│   │   ├── __init__.py
│   │   ├── bean_service.py      # Bean CRUD
│   │   ├── blend_service.py     # Blend CRUD + 혼합률 관리
│   │   ├── roasting_service.py  # RoastingLog CRUD + 월별 조회
│   │   ├── cost_service.py      # 원가 계산 (혼합률 기반)
│   │   ├── analytics_service.py # 분석 로직 (손실률, 수익성)
│   │   ├── report_service.py    # 리포트 생성
│   │   └── excel_sync.py        # Excel ↔ DB 동기화
│   ├── components/
│   │   ├── __init__.py
│   │   ├── roasting_input_form.py    # 로스팅 기록 입력 폼
│   │   ├── monthly_grid.py           # 월별 그리드 컴포넌트
│   │   ├── loss_rate_chart.py        # 손실률 차트
│   │   ├── blend_pie_chart.py        # 블렌드 혼합률 파이
│   │   └── cost_table.py             # 원가 테이블
│   ├── utils/
│   │   ├── __init__.py
│   │   ├── constants.py         # 13종 원두, 2가지 블렌드 정의
│   │   ├── validators.py        # 데이터 검증
│   │   ├── formatters.py        # 포맷팅 (통화, 백분율)
│   │   └── helpers.py           # 헬퍼 함수
│   └── test_data.py             # 테스트 데이터 생성
├── Data/
│   ├── roasting_data.db         # SQLite DB
│   ├── backups/                 # 자동 백업
│   └── exports/                 # 리포트 내보내기
├── Documents/
│   ├── Planning/
│   │   └── 통합_웹사이트_구현_마스터플랜_v2.md
│   ├── Architecture/
│   └── Progress/
└── logs/
    ├── VERSION
    └── CHANGELOG.md
```

### C. 데이터베이스 스키마

```sql
-- 1. 원두 (13종)
CREATE TABLE beans (
    id INTEGER PRIMARY KEY,
    no INTEGER UNIQUE,                    -- 1~13
    country_code VARCHAR(3),              -- ETH, K, CO, etc.
    name VARCHAR(50) UNIQUE,              -- 마사이, 안티구아, etc.
    roast_level VARCHAR(10),              -- W(hite), N(normal), etc.
    description TEXT,
    image_url VARCHAR(255),
    price_per_kg DECIMAL(10,2),          -- 생두 원가 (₩/kg)
    status VARCHAR(20) DEFAULT 'active',  -- active, inactive
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. 블렌드 (풀문, 뉴문)
CREATE TABLE blends (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) UNIQUE,              -- Full Moon, New Moon
    description TEXT,
    loss_rate_percent DECIMAL(5,2) DEFAULT 17.0,  -- 혼합 후 손실률
    standard_selling_price DECIMAL(10,2), -- 표준 판매가
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. 블렌드 레시피 (혼합률) - 현재 버전
CREATE TABLE blend_recipes (
    id INTEGER PRIMARY KEY,
    blend_id INTEGER NOT NULL,
    bean_id INTEGER NOT NULL,
    blending_ratio_percent DECIMAL(5,2) NOT NULL,  -- 0~100, 합계=100%
    version INTEGER DEFAULT 1,                      -- 레시피 버전
    effective_date DATE NOT NULL,                  -- 적용 시작일
    is_current BOOLEAN DEFAULT true,               -- 현재 레시피 여부
    sort_order INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (blend_id) REFERENCES blends(id),
    FOREIGN KEY (bean_id) REFERENCES beans(id),
    INDEX idx_blend_current (blend_id, is_current)
);

-- 3-2. 블렌드 레시피 히스토리 (버전 관리)
CREATE TABLE blend_recipes_history (
    id INTEGER PRIMARY KEY,
    blend_id INTEGER NOT NULL,
    bean_id INTEGER NOT NULL,
    blending_ratio_percent DECIMAL(5,2) NOT NULL,
    version INTEGER NOT NULL,
    effective_from DATE NOT NULL,                  -- 적용 시작일
    effective_to DATE,                             -- 적용 종료일
    reason VARCHAR(200),                           -- 변경 이유 (비용 절감, 품질 개선 등)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(50),
    FOREIGN KEY (blend_id) REFERENCES blends(id),
    FOREIGN KEY (bean_id) REFERENCES beans(id),
    INDEX idx_blend_history (blend_id, effective_from)
);

-- 4. 로스팅 기록
CREATE TABLE roasting_logs (
    id INTEGER PRIMARY KEY,
    bean_id INTEGER NOT NULL,
    raw_weight_kg DECIMAL(10,2) NOT NULL,        -- 생두량
    roasted_weight_kg DECIMAL(10,2) NOT NULL,    -- 로스팅량
    loss_rate_percent DECIMAL(5,2),              -- 자동 계산: (raw-roasted)/raw
    expected_loss_rate_percent DECIMAL(5,2),     -- 마스터데이터 예상값 (기본 17%)
    loss_variance_percent DECIMAL(5,2),          -- 편차: actual - expected
    roasting_date DATE NOT NULL,
    roasting_month VARCHAR(7),                   -- 2025-10 형식
    blend_recipe_version_id INTEGER,             -- 이 로스팅에 사용된 레시피 버전
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (bean_id) REFERENCES beans(id),
    FOREIGN KEY (blend_recipe_version_id) REFERENCES blend_recipes(id),
    INDEX idx_roasting_month (roasting_month),
    INDEX idx_bean_id (bean_id),
    INDEX idx_roasting_date (roasting_date)
);

-- 5. 거래 (판매/사용)
CREATE TABLE transactions (
    id INTEGER PRIMARY KEY,
    blend_id INTEGER NOT NULL,
    type VARCHAR(20),                  -- sales, usage
    quantity_kg DECIMAL(10,2),
    price DECIMAL(10,2),
    transaction_date DATE NOT NULL,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (blend_id) REFERENCES blends(id),
    INDEX idx_transaction_date (transaction_date)
);

-- 6. 재고
CREATE TABLE inventory (
    id INTEGER PRIMARY KEY,
    bean_id INTEGER UNIQUE NOT NULL,
    quantity_kg DECIMAL(10,2) DEFAULT 0,
    min_quantity_kg DECIMAL(10,2),
    max_quantity_kg DECIMAL(10,2),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (bean_id) REFERENCES beans(id)
);

-- 7. 설정
CREATE TABLE settings (
    id INTEGER PRIMARY KEY,
    key VARCHAR(100) UNIQUE,
    value TEXT,
    description TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 8. 사용자 (권한 관리)
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role VARCHAR(20),                   -- admin, owner, staff, worker, guest
    is_active BOOLEAN DEFAULT true,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_role (role)
);

-- 8-2. 사용자 권한 (페이지별)
CREATE TABLE user_permissions (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    page_name VARCHAR(100),             -- 페이지명 (예: '대시보드', '로스팅기록')
    can_read BOOLEAN DEFAULT false,
    can_write BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE(user_id, page_name),
    INDEX idx_user_permissions (user_id)
);

-- 8-3. 접근 로그
CREATE TABLE access_logs (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    page_name VARCHAR(100),
    action VARCHAR(20),                 -- view, edit, delete
    resource_id INTEGER,
    status VARCHAR(20),                 -- success, denied, error
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_access (user_id, timestamp),
    INDEX idx_page_access (page_name, timestamp)
);

-- 9. 감사 로그 (모든 데이터 변경 추적)
CREATE TABLE audit_logs (
    id INTEGER PRIMARY KEY,
    table_name VARCHAR(50),
    operation VARCHAR(20),              -- INSERT, UPDATE, DELETE
    record_id INTEGER,
    old_values JSON,
    new_values JSON,
    user_id INTEGER,
    user_name VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_audit_date (created_at),
    INDEX idx_audit_table (table_name)
);

-- 10. 손실률 이상 알림
CREATE TABLE loss_rate_warnings (
    id INTEGER PRIMARY KEY,
    roasting_log_id INTEGER NOT NULL,
    bean_id INTEGER NOT NULL,
    roasting_month VARCHAR(7),
    actual_loss_rate DECIMAL(5,2),
    expected_loss_rate DECIMAL(5,2),
    variance_percent DECIMAL(5,2),
    status VARCHAR(20),                 -- new, reviewed, resolved
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP,
    resolved_by VARCHAR(50),
    FOREIGN KEY (roasting_log_id) REFERENCES roasting_logs(id),
    FOREIGN KEY (bean_id) REFERENCES beans(id),
    INDEX idx_warning_status (status),
    INDEX idx_warning_date (created_at)
);
```

---

## 5. TASKS (작업 분해)

### 통합 작업 분해

#### Phase 1: 데이터 기초 구축 (2주)

| Task | 설명 | 기간 | 현황 |
|------|------|------|------|
| **T1-1** | 기존 로스팅 기록 마이그레이션 (Sheet1 데이터) + 검증 | 3일 | Pending |
| **T1-2** | 원두 마스터 데이터 설정 (13종) | 1일 | Pending |
| **T1-3** | 블렌드 혼합률 설정 (Sheet1(2) 데이터) | 1일 | Pending |
| **T1-4** | 원가 정보 입력 (생두원가/판매가) | 2일 | Pending |
| **T1-5** | 데이터 검증 및 정제 | 2일 | Pending |
| **T1-6** | 손실률 임계값 설정 & 이상 탐지 규칙 | 1.5일 | Pending |

#### Phase 2: 백엔드 서비스 개발 (2.5주)

| Task | 설명 | 기간 | 현황 |
|------|------|------|------|
| **T2-1** | DB 스키마 설계 & 마이그레이션 | 2.5일 | Pending |
| **T2-2** | SQLAlchemy 모델 정의 (10개 모델 - 권한, 알림 포함) | 2.5일 | Pending |
| **T2-3** | RoastingService 개발 (CRUD + 월별 조회) | 2일 | Pending |
| **T2-4** | BlendService 개발 (혼합률 관리 + 버전 관리) | 2.5일 | Pending |
| **T2-5** | CostService 개발 (혼합률 기반 원가 계산) | 2일 | Pending |
| **T2-6** | AnalyticsService + 손실률 이상 탐지 | 2일 | Pending |
| **T2-7** | Excel 동기화 서비스 (단방향) | 1.5일 | Pending |
| **T2-8** | Unit Test 작성 (목표: 90% 커버리지) | 3일 | Pending |
| **T2-9** | 코드 리뷰 및 리팩토링 | 2일 | Pending |

#### Phase 3: 프론트엔드 개발 (3주)

| Task | 설명 | 기간 | 현황 |
|------|------|------|------|
| **T3-1** | 로그인 페이지 & 권한 미들웨어 (Login.py) | 1.5일 | Pending |
| **T3-2** | 대시보드 페이지 (Dashboard.py) - 월별 요약 | 2일 | Pending |
| **T3-3** | 로스팅 기록 입력 (RoastingRecord.py) - 단일 입력 | 1.5일 | Pending |
| **T3-4** | 영수증 형식 입력 (RoastingReceipt.py) - 월별 그리드 | 2.5일 | Pending |
| **T3-5** | 블렌딩 관리 (BlendManagement.py) | 1.5일 | Pending |
| **T3-6** | 원가 계산 (CostCalculation.py) | 1.5일 | Pending |
| **T3-7** | 분석 페이지 (Analysis.py) - 손실률, 수익성 | 2일 | Pending |
| **T3-8** | 보고서 생성 (Report.py) | 1.5일 | Pending |
| **T3-9** | 설정 페이지 (Settings.py) - 원가, 판매가, 권한 | 2일 | Pending |
| **T3-10** | UI/UX 개선 & 반응형 디자인 | 2일 | Pending |
| **T3-11** | 성능 최적화 (캐싱, 인덱싱, 페이지네이션) | 2일 | Pending |

#### Phase 4: 통합 & 테스트 (2주)

| Task | 설명 | 기간 | 현황 |
|------|------|------|------|
| **T4-1** | 통합 테스트 작성 및 실행 (주요 사용 케이스) | 2.5일 | Pending |
| **T4-2** | 성능 테스트 (페이지 로딩, DB 쿼리) | 2.5일 | Pending |
| **T4-3** | 사용자 수용 테스트 (UAT) 실행 | 2일 | Pending |
| **T4-4** | 버그 수정 및 개선 | 2.5일 | Pending |
| **T4-5** | 최종 성능 검증 (모든 목표 달성 확인) | 1.5일 | Pending |

#### Phase 5: 배포 & 운영 (1.5주)

| Task | 설명 | 기간 | 현황 |
|------|------|------|------|
| **T5-1** | 운영 매뉴얼 작성 (설치, 관리, 백업) | 1.5일 | Pending |
| **T5-2** | 직원 교육 & 시연 (담당자 중심) | 1.5일 | Pending |
| **T5-3** | 시스템 배포 & 초기 설정 | 1.5일 | Pending |
| **T5-4** | 초기 운영 지원 (버그 모니터링, 최적화) | 1주 | Pending |

#### Buffer: 문제 대응 및 예상 지연 (1주)

| Task | 설명 | 기간 | 현황 |
|------|------|------|------|
| **예비** | 예상 지연/추가 이슈 대응 | 1주 | Pending |

### 세부 작업 명세

#### T1-1: 기존 로스팅 기록 마이그레이션 (Sheet1 데이터) - 상세화 v2

**요구사항:**
- Excel Sheet1의 월별 로스팅 기록 (2개월분) → DB로 이전
- 원두별 행 × 월별 열 구조 파싱
- 생두량, 로스팅량 데이터 추출
- 손실률 자동 계산
- **검증 및 롤백 전략 포함** (v2 신규)

**산출물:**
- app/services/excel_sync.py: migrate_roasting_logs() 함수
- roasting_logs 테이블에 60개 이상 레코드
- 마이그레이션 검증 리포트

**마이그레이션 프로세스:**

```
사전 검증 (Pre-Migration):
□ Excel 파일 백업 (3개 사본)
□ DB 스냅샷 생성
□ 마이그레이션 스크립트 테스트 환경 검증

마이그레이션 중:
□ 트랜잭션 wrapping (롤백 가능)
□ 진행률 로깅 (매 10건마다)
□ 에러 발생 시 자동 롤백

마이그레이션 후 검증:
□ 행 수 검증 (원본 == 마이그레이션)
  예: 원본 60행 = 마이그레이션 60행 ✓
□ 합계 검증 (생두량 = 31,325.3kg ± 0.1%)
□ 손실률 검증 (모두 16~18% 범위)
□ 날짜 범위 검증 (2025-09, 2025-10)
□ NULL 값 검증 (필수 필드 완전)
□ 중복 검증 (같은 원두/달 중복 없음)
□ 원두명 검증 (13종 모두 포함)
```

**에러 처리:**

```python
마이그레이션 실패 시나리오:

1. 원두명 오류
   "마사이" vs "마사이 " (공백)
   → 정규화: 양쪽 공백 제거

2. 데이터 타입 오류
   "1,000" (천 단위 쉼표)
   → 정규화: 쉼표 제거 후 float 변환

3. 범위 오류
   생두량 0 또는 음수
   → 에러 메시지: "행 5: 생두량 > 0 필수"

4. 논리 오류
   로스팅량 > 생두량
   → 에러 메시지: "행 8: 로스팅량 <= 생두량 필수"

5. 손실률 이상
   손실률 > 25% (비정상)
   → 경고: "행 12: 손실률 28.5% (정상 16~18%)"

모든 에러는 상세 로그에 기록되고,
사용자에게 수정 방법을 제시함
```

**검증 예시:**

```
마이그레이션 전:
- Excel: Sheet1 (60행)
  마사이, 10,602.4kg, 8,800kg
  안티구아, 10,602.4kg, 8,800kg
  ...

마이그레이션 후:
✓ 60개 행 삽입 완료
✓ 생두량 합계: 31,325.3kg
✓ 로스팅량 합계: 26,000kg
✓ 평균 손실률: 17.0%
✓ 모든 데이터 정상

⚠️ 경고: 3건
  - 행 28: 손실률 18.2% (약간 높음)
  - 행 45: 손실률 16.1% (약간 낮음)
  - 행 51: 손실률 17.8% (정상 범위)

→ 사용자 확인 필요 없음 (범위 내)
```

**롤백 전략:**

```
방법 1: 스냅샷 복원 (권장)
- 마이그레이션 전 DB 스냅샷 생성
- 문제 발생 시 스냅샷 복원 (1분 내)

방법 2: SQL 스크립트
- roasting_logs의 마이그레이션 후 모든 레코드 삭제
- DELETE FROM roasting_logs WHERE created_at > '2025-10-29'

방법 3: 감사 로그 기반 (복잡)
- audit_logs 테이블의 INSERT 기록 역순 처리
```

#### T1-2: 원두 마스터 데이터 설정 (13종)

```
요구사항:
- 13종 원두 정보 beans 테이블에 입력
- 각 원두별 생두 원가(₩/kg) 입력
- 국가코드, 로스팅 레벨 설정

산출물:
- beans 테이블 13개 레코드
- app/utils/constants.py에 원두 마스터 데이터 정의
```

#### T1-3: 블렌드 혼합률 설정 (Sheet1(2) 데이터)

```
요구사항:
- 블렌드 테이블에 풀문, 뉴문 등록
- blend_recipes 테이블에 혼합률(%) 설정
  - 풀문: 마사이 40%, 안티구아 40%, 모모라 10%, g4 10%
  - 뉴문: 브라질 60%, 콜롬비아 30%, g4 10%
- 블렌드별 손실률(17%) 표준화
- 블렌드별 판매가 설정

산출물:
- blends 테이블 2개 레코드
- blend_recipes 테이블 7개 레코드
```

#### T2-5: CostService 개발

```python
주요 함수:
1. calculate_blend_cost(blend_id, bean_costs_dict)
   → 혼합 비중별 원가 = 각 원두 원가 × 혼합률(%)
   → 블렌드 총 원가 = Σ(혼합 비중별 원가)

2. calculate_final_cost(blend_cost, loss_rate)
   → 최종 원가 = 블렌드 원가 / (1 - 손실률)

3. calculate_monthly_blend_cost(blend_id, roasting_month)
   → 월간 블렌드별 원가 (로스팅 기록 기반)

테스트 케이스:
- 풀문 혼합 원가 계산
- 손실률 17% 반영 최종 원가
- 뉴문 혼합 원가 계산
```

#### T3-3: 영수증 형식 월별 로스팅 입력 (그리드)

```python
페이지명: pages/RoastingReceipt.py

UI 구성:
1. 월 선택 (드롭다운)
2. 원두별 행 × 3열 (생두량, 로스팅량, 손실률)
3. st.data_editor로 그리드 편집 구현
4. [저장] [목록] [Excel 다운로드] 버튼

백엔드:
- RoastingService.get_monthly_records(month)
- RoastingService.save_monthly_batch(records)
- 자동 검증 및 에러 처리
```

---

## 6. IMPLEMENT (자동 코드 생성)

### 구현 순서 및 일정

#### Phase 1: 데이터 기초 구축

**순서:**
1. T1-1: Excel → DB 마이그레이션 (app/services/excel_sync.py)
2. T1-2: 원두 마스터 데이터 입력 (app/utils/constants.py)
3. T1-3: 블렌드 혼합률 설정 (blend_recipes)
4. T1-4: 원가 정보 입력 (bean.price_per_kg, blend.selling_price)
5. T1-5: 데이터 검증 및 정제

#### Phase 2: 백엔드 서비스 개발

**순서:**
1. T2-1: DB 스키마 설계 (app/models/database.py)
2. T2-2: SQLAlchemy 모델 (8개 모델 파일)
3. T2-3: RoastingService (로스팅 기록 CRUD)
4. T2-4: BlendService (블렌드 관리)
5. T2-5: CostService (원가 계산 로직)
6. T2-6: AnalyticsService (분석)
7. T2-7: ExcelSync (양방향 동기화)
8. T2-8: Unit Tests

#### Phase 3: 프론트엔드 개발

**순서:**
1. T3-1: 대시보드 (pages/Dashboard.py)
2. T3-2: 로스팅 기록 단일 입력 (pages/RoastingRecord.py)
3. T3-3: 영수증 형식 그리드 입력 (pages/RoastingReceipt.py)
4. T3-4: 블렌딩 관리 (pages/BlendManagement.py)
5. T3-5: 원가 계산 (pages/CostCalculation.py)
6. T3-6: 분석 (pages/Analysis.py)
7. T3-7: 보고서 (pages/Report.py)
8. T3-8: 설정 (pages/Settings.py)
9. T3-9: UI/UX 개선

---

## 7. ANALYZE (검증)

### 기능 검증 체크리스트

#### 로스팅 기록 관리
- [ ] 단일 입력 페이지: 개별 로스팅 기록 저장 성공
- [ ] 월별 그리드 입력: 영수증 형식 편집 가능
- [ ] 손실률 자동 계산: (생두량 - 로스팅량) / 생두량 정확성
- [ ] 데이터 검증: 생두량, 로스팅량 범위 검증
- [ ] 기존 데이터: 2개월분 60개 레코드 마이그레이션 완료

#### 블렌드 관리
- [ ] 블렌드 정보 표시: 풀문, 뉴문 정보 정확
- [ ] 혼합률 표시: 각 원두의 혼합 비율(%) 정확
- [ ] 혼합률 합계: 100% 검증 및 자동 정정
- [ ] 블렌드 파이 차트: 시각화 정확성

#### 원가 계산
- [ ] 혼합 비중별 원가: 원두원가 × 혼합률(%) 정확
- [ ] 블렌드 원가: 모든 원두의 혼합 원가 합계 정확
- [ ] 최종 원가: 블렌드원가 / (1 - 17%) 정확
- [ ] 수익성: 판매가 - 최종 원가 계산 정확

#### 분석
- [ ] 월별 손실률 추이: 차트 표시 정확
- [ ] 원두별 통계: 월간 로스팅량 정확
- [ ] 블렌드별 분석: 블렌드별 월간 원가 정확
- [ ] 목표 대비: 17% vs 14% 목표 시각화

#### 데이터 검증
- [ ] DB 무결성: Foreign Key 제약 조건 작동
- [ ] Excel ↔ DB 동기화: 양방향 데이터 일치
- [ ] 손실률 일관성: 모든 로스팅 기록의 손실률 17% 표준화
- [ ] 감사 로그: 모든 변경 기록 자동 저장

#### 성능 검증
- [ ] 페이지 로딩: < 2초
- [ ] 월별 그리드: st.data_editor 반응성 < 1초
- [ ] 차트 렌더링: Plotly 차트 < 1초
- [ ] DB 쿼리: SELECT 쿼리 < 500ms

#### 사용성 검증
- [ ] 직관적 UI: 담당자 사용 가능
- [ ] 에러 메시지: 명확한 사용자 피드백
- [ ] 반응형 디자인: 모바일 호환
- [ ] 접근성: 키보드 네비게이션 가능

---

## 📊 예상 결과물

```
✅ 완전한 로스팅 데이터 관리 시스템
✅ 혼합률 기반 정확한 원가 계산
✅ 월별 손실률 추적 및 분석
✅ 영수증 형식 실제 업무 프로세스 반영
✅ Excel ↔ DB 자동 동기화
✅ 월간/분기/연간 자동 보고서
✅ 확장 가능한 아키텍처
✅ 모바일 호환 반응형 디자인
```

---

## 🎯 타임라인 (v2.1 - 개선된 일정)

| Phase | 기간 | 주요 작업 | 누적 기간 |
|-------|------|---------|---------|
| **1** | 2주 | 데이터 마이그레이션 & 설정 + 손실률 검증 | 2주 |
| **2** | 2.5주 | 백엔드 서비스 개발 (10개 서비스) + Unit Test | 4.5주 |
| **3** | 3주 | 프론트엔드 개발 (11개 페이지) + 성능 최적화 | 7.5주 |
| **4** | 2주 | 통합/성능/UAT 테스트 | 9.5주 |
| **5** | 1.5주 | 배포 & 초기 운영 지원 | 11주 |
| **Buffer** | 1주 | 예상 지연 & 추가 이슈 대응 | 12주 |
| **합계** | **9주** (약 2개월) | **전체 완성** | **9주** |

**개선사항:**
- 이전: 6.5주 (버퍼 없음, 위험)
- 현재: 9주 (38% 증가, 1주 버퍼 포함)
- Phase별 비용 증가: 마이그레이션 +0.5주, 백엔드 +0.5주, 프론트엔드 +0.5주, 테스트 +1주

---

## ✅ 최종 체크리스트 (v2.1 - 개선됨)

**P0 (필수 요소)**

데이터 구축 (Phase 1):
☐ 2개월분 로스팅 데이터 마이그레이션 (60개 레코드)
  - 사전 검증 (백업, 스냅샷, 테스트)
  - 마이그레이션 중 (트랜잭션, 로깅)
  - 사후 검증 (합계, 손실률, 중복)
  - 롤백 전략 검증
☐ 13종 원두 마스터데이터 입력
☐ 블렌드 혼합률 설정 (풀문, 뉴문) + 버전 관리
☐ 원가 정보 입력 (생두원가/판매가)
☐ 손실률 임계값 설정 (16~18%) & 이상 탐지 규칙

백엔드 개발 (Phase 2):
☐ DB 스키마 완성 (10개 테이블)
  - blend_recipes_history (버전 관리)
  - loss_rate_warnings (이상 탐지)
  - users, user_permissions, access_logs (권한)
☐ 10개 서비스 개발
  - RoastingService: CRUD + 월별 조회 + 검증
  - CostService: **혼합률 기반** 원가 계산 (생두 기준)
  - BlendService: 혼합률 관리 + 버전 관리
  - AnalyticsService: 손실률 분석 + 이상 탐지
  - AuthService: 사용자 인증 & 권한 검사
☐ Unit Test (목표: 90% 커버리지)
  - CostService 함수 100% 테스트
  - 손실률 검증 로직 100% 테스트
  - 원가 계산 정확성 검증

프론트엔드 개발 (Phase 3):
☐ 11개 페이지 개발
  - 로그인 페이지 & 권한 미들웨어
  - 대시보드: 월별 요약 + 손실률 추이
  - 로스팅 기록: 단일 입력 + 월별 그리드 (영수증 형식)
  - 블렌딩 관리: 혼합률(%) 시각화 + 버전 변경
  - 분석: 손실률 분석 + 수익성 분석 + 이상 탐지
  - 설정: 원가, 판매가, 권한 관리
☐ 성능 최적화
  - 캐싱 전략 (st.cache_data)
  - DB 인덱싱 전략
  - 월별 그리드 페이지네이션
  - 목표 달성: 대시보드 <1초, 그리드 <2초, 분석 <2.5초

테스트 & 최적화 (Phase 4):
☐ 통합 테스트 작성 및 실행
  - 마이그레이션 → 검증 흐름
  - 로스팅 기록 입력 → 원가 계산 → 분석
  - 블렌드 변경 → 영향도 분석
☐ 성능 테스트
  - 페이지 로딩 시간 < 2초 (목표)
  - DB 쿼리 응답시간 < 500ms
  - Streamlit 그리드 편집 반응성 < 1초
☐ UAT (사용자 수용 테스트)
  - 담당자: 영수증 형식 입력 기능
  - 점주: 분석 & 리포트 기능
  - 직원: 로스팅 기록 조회 기능
☐ 버그 수정 완료

배포 & 운영 (Phase 5):
☐ requirements.txt 최신화
☐ 운영 매뉴얼 작성
  - 설치 절차
  - 백업/복구 절차
  - 권한 관리 가이드
  - 문제 해결 가이드
☐ 직원 교육 (담당자 중심)
  - 영수증 형식 로스팅 입력
  - 월별 리포트 생성
  - 비상 상황 처리
☐ 프로덕션 배포
☐ 초기 운영 지원 (1주)
  - 모니터링 & 성능 조정
  - 버그 패치
  - 사용자 피드백 수집

**P1 (권장 요소)**

품질 보증:
☐ 명세 ↔ 코드 100% 일치 검증
☐ 혼합률(%) 정의 명확화 문서화
☐ 원가 계산 정확성 검증 (실제 데이터 기반)
☐ 손실률 일관성 검증 (17% ±1%)
☐ 로스팅 데이터 완전성 검증

보안 & 감시:
☐ 사용자 인증 & 권한 관리 작동 확인
☐ 감사 로그 기록 및 조회 기능
☐ 접근 로그 수집 및 분석
☐ 데이터 백업 자동화

**P2 (선택 요소)**

고급 기능:
☐ 모니터링 대시보드 (손실률, DB 성능)
☐ Slack 알림 통합 (이상 탐지 시)
☐ 자동 보고서 생성 (주간/월간)
☐ 클라우드 백업 통합
```

---

## 📝 버전 정보

**문서명:** 통합_웹사이트_구현_마스터플랜_v2.md
**버전:** 2.1 (전문가 검토 반영)
**작성일:** 2025-10-29
**마지막 수정:** 2025-10-29
**상태:** ✅ 최종 개선 완료 (Phase 1 시작 준비)

**주요 개선사항 (v2 → v2.1):**
1. ✅ 혼합률(%) 정의 명확화 (Clarify 섹션)
2. ✅ DB 스키마 확대 (버전 관리, 권한, 손실률 이상 탐지)
3. ✅ roasting_logs 테이블 확장 (손실률 편차, 레시피 버전)
4. ✅ T1-1 마이그레이션 상세화 (검증, 롤백 전략)
5. ✅ 일정 재계획 (6.5주 → 9주)
6. ✅ Phase별 Task 추가 (권한 관리, 성능 최적화, 테스트 확대)
7. ✅ 최종 체크리스트 P0/P1/P2 분류

**다음 단계:**
1. **Phase 1 시작 (T1-1: 마이그레이션)**
2. **DB 스키마 생성 (SQLAlchemy 모델 정의)**
3. **마이그레이션 스크립트 작성 및 테스트**

---

## 📝 문서 정보

**문서명:** 통합_웹사이트_구현_마스터플랜_v2.md
**작성일:** 2025-10-29
**버전:** 2.0
**상태:** ✅ 준비 완료 (Phase 1 시작 대기)
**기반 문서:**
- 로스팅_플랜_2025.md (로스팅 데이터 & 혼합률 기반 설계)
- 웹페이지_구현_마스터플랜.md (웹사이트 기본 구조)

**마지막 검토:** 2025-10-29
