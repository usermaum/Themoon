# 세션 요약 - 2025년 11월 15일 (세션 3)

**날짜**: 2025-11-15
**버전**: v0.46.0 → [Unreleased]
**주요 작업**: GSC 명세서 OCR 파싱 로직 개선
**작업 시간**: 약 2시간

---

## 📋 작업 개요

이번 세션에서는 실제 GSC 명세서 이미지(IMG_1650.PNG)로 OCR 테스트를 수행하고, 파싱 실패 원인을 분석하여 파싱 로직을 개선했습니다.

---

## ✅ 완료된 작업

### 1. OCR 환경 설정
- **EasyOCR 패키지 설치**: easyocr==1.7.0, pytesseract==0.3.10
- **NumPy 버전 호환성 해결**: NumPy 2.x → 1.x 다운그레이드
- **Pillow 호환성 패치**: Image.ANTIALIAS → Image.LANCZOS 치환
  - 문제: EasyOCR 1.7.0이 Pillow 10.x와 호환되지 않음
  - 해결: `venv/lib/python3.12/site-packages/easyocr/utils.py` 패치
  - 자동화: `scripts/patch_easyocr.sh` 스크립트 작성

### 2. OCR 테스트 스크립트 작성
- **파일**: `test_ocr.py`
- **기능**:
  - 실제 명세서 이미지로 OCR 수행
  - 파싱 결과 상세 출력 (날짜, 금액, 항목)
  - 신뢰도 점수 측정
  - OCR 원본 텍스트 출력 (처음 500자)

### 3. GSC 명세서 파싱 로직 개선

#### 3.1 날짜 파싱 개선 (`parse_gsc_invoice()`)
**문제**:
- OCR 결과: "2025 = 109 29일" (년→=, 월→9, 줄바꿈 포함)
- 기존 패턴: `계약일자\s*[:：]\s*(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일` (매칭 실패)

**해결**:
```python
# 개선된 패턴 (app/utils/text_parser.py:602)
date_pattern = r'계약일자\s*[:：]?\s*(\d{4})\s*[년=\-]\s*(\d{1,3})\s*[월9oO]\s*(\d{1,2})\s*일'
```
- `:` 선택적 (`:?`)
- `년` → `[년=\-]` (=, - 허용)
- `월` → `[월9oO]` (9, o, O 허용)
- 월이 3자리인 경우 마지막 2자리만 사용 (109 → 10)

**결과**: ✅ "2025 = 109 29일" → 2025-10-29

#### 3.2 금액 파싱 개선 (`parse_gsc_invoice()`)
**문제**:
- OCR 결과: "학계금액 1825003) 원" (합→학, 액→9, 괄호 포함)
- 기존 패턴: `합계금액\s*[:：]\s*([\d,]+)\s*원` (매칭 실패)

**해결**:
```python
# 개선된 패턴 (app/utils/text_parser.py:634)
amount_pattern = r'[합학][계]\s*[금액]*[9]?\s*[:：]?\s*([\d,\-\)]+)\s*원'
```
- `합` → `[합학]`
- `계` 다음에 `[금액]*[9]?` 추가
- `:` 선택적
- 숫자 패턴에 `-`, `)` 허용

**결과**: ✅ "학계금액 1825003) 원" → 1,825,003

#### 3.3 항목 파싱 개선 (`parse_gsc_table()`)
**문제**:
- OCR 결과: 각 필드가 별도 줄에 있음 (여러 줄에 걸친 항목)
```
Colombis Supremo Huila
1kg
30
30
1250)
235.009
```
- 기존 로직: 한 줄씩 파싱 (매칭 실패)

**해결**:
```python
# 줄바꿈을 공백으로 치환 (app/utils/text_parser.py:693)
table_text_flat = ' '.join(table_text.split('\n'))

# 전체 텍스트에서 패턴으로 항목 추출
pattern = r'([A-Z][a-zA-Z\s_]+?)\s+(\d+\s*[Kk][Gg9])\s+(\d+)\s+(\d+(?:\.\d+)?)\s+([\d,\.\)]+)\s+([\d,\.\)]+)'
```
- 줄바꿈 제거하여 한 줄로 만듦
- 영문 대문자로 시작하는 원두명 패턴 매칭
- 규격 패턴에 `9` 추가 (kg → k9 오인식 대응)
- 단가/금액에 `.`, `)` 허용

**결과**: ✅ 4개 항목 성공적으로 추출

### 4. 최종 테스트 결과 (IMG_1650.PNG)

| 필드 | OCR 텍스트 | 파싱 결과 | 상태 |
|------|-----------|-----------|------|
| **날짜** | "2025 = 109 29일" | 2025-10-29 | ✅ |
| **금액** | "학계금액 1825003) 원" | 1,825,003원 | ✅ |
| **항목 1** | "Colombis Supremo Huila 1kg 30 30 1250) 235.009" | Colombis Supremo Huila / 1kg × 30 = 30kg | ✅ |
| **항목 2** | "Colombia Supremo Dopayan sugarcane 1k9 30 30 21.009 630009" | Colombia Supremo Dopayan sugarcane / 1kg × 30 = 30kg | ✅ |
| **항목 3** | "Ethiopia G_ Sidsmo Natural 1k9 30 30 1200) 360009" | Ethiopia G_ Sidsmo Natural / 1kg × 30 = 30kg | ✅ |
| **항목 4** | "Ethiopia G2 Yirgacheffe Washed 1k9 30 30 1200) 220.009" | Yirgacheffe Washed / 1kg × 30 = 30kg | ✅ |

**신뢰도**:
- OCR 인식: 55.5%
- 파싱 신뢰도: 76.1%
- 전체 신뢰도: **100.0%** (날짜, 금액, 항목 모두 성공)

### 5. 문서화 및 자동화
- **패치 스크립트**: `scripts/patch_easyocr.sh` 작성
  - EasyOCR Pillow 호환성 자동 패치
  - 백업 생성, 변경 확인 기능 포함
- **설치 가이드 업데이트**: README.md (3-1단계 추가)
- **의존성 추가**: requirements.txt (easyocr==1.7.0)

---

## 📊 변경 파일

### 수정 파일
- `app/utils/text_parser.py` (3곳 수정)
  - `parse_gsc_invoice()`: 날짜/금액 패턴 개선
  - `parse_gsc_table()`: 줄바꿈 처리 로직 개선
  - `parse_gsc_table_row()`: 규격 오인식 대응 (사용되지 않지만 유지)

### 새 파일
- `test_ocr.py`: OCR 종합 테스트 스크립트
- `scripts/patch_easyocr.sh`: EasyOCR 자동 패치 스크립트

### 문서 업데이트
- `requirements.txt`: easyocr==1.7.0 추가
- `README.md`: EasyOCR 패치 안내 추가 (3-1단계)
- `logs/CHANGELOG.md`: Unreleased 섹션 추가
- `Documents/Progress/SESSION_SUMMARY_2025-11-15_03.md`: 이 파일

---

## 💡 배운 점 & 개선사항

### OCR 오인식 패턴 대응 전략
1. **공통 오인식 패턴 분석**:
   - 한글: 년→=, 월→9, 합→학, 액→9
   - 영문: kg→k9, g→9
   - 기호: 콤마→하이픈, 괄호 추가

2. **정규식 패턴 개선**:
   - 문자 클래스 사용: `[년=\-]`, `[월9oO]`, `[합학]`
   - 선택적 패턴: `[:：]?`, `[금액]*[9]?`
   - 허용 범위 확대: `[\d,\-\)]`

3. **줄바꿈 처리**:
   - OCR 결과가 여러 줄에 걸쳐 있을 수 있음
   - 줄바꿈 제거 후 패턴 매칭

### EasyOCR 패키지 관리
- **호환성 문제**: Pillow 버전과 EasyOCR 버전 충돌
- **해결 전략**:
  1. 패치 스크립트 자동화
  2. 설치 가이드에 명시
  3. venv 내부 파일 수정 (임시 해결책)
- **향후 개선**: EasyOCR 업데이트 시 재확인 필요

---

## 🎯 다음 단계

1. **IMG_1651.PNG 테스트**: 두 번째 명세서 이미지로 추가 테스트
2. **신뢰도 개선**: OCR 전처리 최적화 (대비, 밝기, 노이즈 제거)
3. **HACIELO 명세서 파싱**: 두 번째 타입 명세서 지원
4. **에러 처리 강화**: 파싱 실패 시 상세 로그 및 사용자 피드백
5. **UI 통합**: ImageInvoiceUpload 페이지에 개선된 파싱 로직 통합

---

## 📝 커밋 내역

```bash
0a75cd3 feat: OCR 파싱 로직 개선 (GSC 명세서 대응)
cbcac09 docs: EasyOCR Pillow 호환성 패치 스크립트 및 문서 추가
```

---

## 🏁 세션 종료 시간
- **시작**: 2025-11-15 22:00 (추정)
- **종료**: 2025-11-15 23:00 (추정)
- **총 시간**: 약 2시간
