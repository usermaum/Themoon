# 세션 요약 - 2025년 11월 16일

**날짜**: 2025-11-16
**버전**: v0.46.0 → [Unreleased]
**주요 작업**: GSC 명세서 OCR 파싱 로직 개선 (수량 유무 패턴 모두 지원)
**작업 시간**: 약 1시간

---

## 📋 작업 개요

이번 세션에서는 어제 (2025-11-15) 작업이 사용제한으로 중단된 부분을 이어서 진행했습니다. IMG_1651.PNG 테스트 중 발견된 새로운 테이블 패턴 (수량 없음)을 지원하기 위해 파싱 로직을 개선했고, IMG_1650.PNG 회귀 테스트에서 문제를 발견하여 두 가지 패턴을 모두 지원하도록 수정했습니다.

---

## ✅ 완료된 작업

### 1. 어제 작업 이어서 진행

**배경:**
- 2025-11-15 세션에서 IMG_1650.PNG OCR 파싱 로직 개선 완료
- IMG_1651.PNG 테스트를 위해 새로운 파싱 로직 개발 중 사용제한 발생
- test_pattern.py → v2 → v3 → v4 로 패턴 개선
- 최종 전략을 text_parser.py에 적용한 상태로 중단

### 2. IMG_1651.PNG 테스트 실행

**테스트 결과:**
- ✅ 날짜: 2025-09-26 (`099 → 09` 변환)
- ✅ 총 금액: 305,300원 (`한계금액` 오인식 대응)
- ✅ 총 중량: 140kg
- ✅ 4개 항목 모두 파싱 (`Sk9 → 5kg` 변환 성공)
- ✅ 전체 신뢰도: **100.0%**

### 3. IMG_1650.PNG 회귀 테스트 실패 발견

**문제:**
- ❌ 원두명에 이전 금액이 붙음: "235.009 Colombia Supremo..."
- ❌ 단가/중량 값이 잘못 파싱됨

**원인 분석:**
두 이미지의 테이블 구조가 다름:
- **IMG_1650**: `품목 규격 수량 중량 단가 금액` (6개 필드, 수량 있음)
- **IMG_1651**: `품목 규격 중량 단가 금액` (5개 필드, 수량 없음)

현재 로직이 IMG_1651에만 맞춰져 있어서 IMG_1650 파싱 실패.

### 4. 파싱 로직 개선 (text_parser.py:703-773)

**개선 내용:**
```python
# 두 가지 패턴 정의
# 패턴 1 (6개 필드): (규격) (수량) (중량) (단가) (금액)
item_pattern_with_qty = rf'({spec_pattern})\s+(\d+(?:\.\d+)?)\s+(\d+(?:\.\d+)?)\s+([\d,\.\)\-]+)\s+([\d,\.\)\-]+)'

# 패턴 2 (5개 필드): (규격) (중량) (단가) (금액)
item_pattern_no_qty = rf'({spec_pattern})\s+(\d+(?:\.\d+)?)\s+([\d,\.\)\-]+)\s+([\d,\.\)\-]+)'

# 자동 감지: 패턴 1로 2개 미만 매칭 시 패턴 2 시도
matches = list(re.finditer(item_pattern_with_qty, table_text_flat))
has_quantity = True

if len(matches) < 2:
    matches = list(re.finditer(item_pattern_no_qty, table_text_flat))
    has_quantity = False

# 원두명 앞 숫자 제거 (이전 항목 금액 오인식 대응)
bean_name = re.sub(r'^[\d,\.\)\-]+\s+', '', bean_name)
```

**주요 개선사항:**
1. **두 가지 패턴 자동 감지**: 먼저 패턴 1 시도, 실패 시 패턴 2 사용
2. **원두명 정리**: 앞에 붙은 숫자 자동 제거
3. **규격 정리 확장**: `Sk9 → 5kg` 변환 추가

### 5. 최종 테스트 결과

**IMG_1650.PNG (패턴 1: 수량 있음)**
- ✅ 날짜: 2025-10-29
- ✅ 총 금액: 1,825,003원
- ✅ 4개 항목 파싱 (수량 30개씩)
- ✅ 전체 신뢰도: **100.0%**

**IMG_1651.PNG (패턴 2: 수량 없음)**
- ✅ 날짜: 2025-09-26
- ✅ 총 금액: 305,300원
- ✅ 4개 항목 파싱 (수량 0개, 중량 20kg씩)
- ✅ 전체 신뢰도: **100.0%**

### 6. 테스트 파일 정리

**삭제한 파일:**
- `test_pattern.py`
- `test_pattern2.py`
- `test_pattern3.py`
- `test_pattern4.py`
- `test_ocr_debug.py`

(어제 패턴 개선 과정에서 생성된 임시 파일들)

---

## 📊 변경 파일

### 수정 파일
- `app/utils/text_parser.py` (text_parser.py:703-773)
  - `parse_gsc_table()`: 두 가지 패턴 자동 감지 및 파싱 로직 추가

### 삭제 파일
- 5개 테스트 파일 (test_pattern*.py, test_ocr_debug.py)

### 문서 업데이트
- `logs/CHANGELOG.md`: Unreleased 섹션 업데이트 (2025-11-16)
- `Documents/Progress/SESSION_SUMMARY_2025-11-16.md`: 이 파일

---

## 💡 배운 점 & 개선사항

### 1. OCR 결과의 다양성 대응

**문제:**
- 동일한 공급자 (GSC)의 명세서지만 테이블 구조가 다를 수 있음
- 수량 필드가 있는 경우 / 없는 경우

**해결:**
- 여러 패턴을 시도하는 fallback 전략
- 패턴 매칭 결과 개수로 자동 감지

### 2. 원두명 추출 시 잡음 제거

**문제:**
- 원두명 앞에 이전 항목의 금액이 붙는 현상
- 예: "235.009 Colombia Supremo..."

**해결:**
- 정규식으로 앞의 숫자 패턴 제거: `r'^[\d,\.\)\-]+\s+'`

### 3. 회귀 테스트의 중요성

**교훈:**
- 새로운 케이스를 지원하기 위해 로직을 변경할 때
- 기존 케이스가 깨지지 않는지 반드시 확인
- 이번에 IMG_1651 지원 후 IMG_1650 회귀 테스트에서 문제 발견

---

## 🎯 다음 단계

1. **다른 명세서 이미지 테스트**: IMG_1652 ~ IMG_1659 추가 테스트
2. **HACIELO 명세서 파싱**: 두 번째 공급자 타입 지원
3. **UI 통합**: ImageInvoiceUpload 페이지에 개선된 파싱 로직 통합
4. **에러 처리 강화**: 파싱 실패 시 상세 로그 및 사용자 피드백

---

## 📝 커밋 내역

```bash
ab554c4 feat: OCR 파싱 로직 개선 (수량 유무 패턴 모두 지원)
```

---

## 🏁 세션 종료 시간
- **시작**: 2025-11-16 12:30 (추정)
- **종료**: 2025-11-16 13:30 (추정)
- **총 시간**: 약 1시간
